
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>å°å¾„åˆ†å²”çš„èŠ±å›­</title>
  <meta name="author" content="khotyn">

  
  <meta name="description" content="">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://khotyn.github.com/blog/page/4">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="å°å¾„åˆ†å²”çš„èŠ±å›­" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44033767-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar navbar-inverse">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">å°å¾„åˆ†å²”çš„èŠ±å›­</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/blog/archives">ğŸ—‚å½’æ¡£</a></li>
  <li><a href="/about">ğŸ‘¨å…³äº</a></li>
  <li><a href="/hire">ğŸ‘¨â€ğŸ’»æ‹›è˜</a></li>
  <li><a href="https://github.com/khotyn" target="_blank">æˆ‘çš„ Github</a></li>
</ul>

        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="https://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:blog.khotyn.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
  
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/09/14/spring-tx-propagation/">Spring äº‹åŠ¡çš„ä¼ æ’­ç‰¹æ€§</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-14T18:06:00+08:00" pubdate data-updated="true">Sep 14<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/09/14/spring-tx-propagation/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>æœ€è¿‘å·¥ä½œä¸­æ¶‰åŠåˆ°äº†ä¸€ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡çš„äº§å“ï¼Œè¿™ä¸ªäº§å“æ˜¯åœ¨ Spring çš„äº‹åŠ¡ä¸Šåšçš„ï¼Œæˆ‘å¯¹å…¶ä¸­æ¶‰åŠåˆ°çš„ Spring çš„äº‹åŠ¡çš„ä¼ æ’­ç‰¹æ€§ä¸æ˜¯å¾ˆäº†è§£ï¼Œæ‰€ä»¥ä»Šå¤©èŠ±äº†ä¸€ä¸ªä¸‹åˆçš„æ—¶é—´è®¤çœŸäº†è§£äº†ä¸€ä¸‹ï¼Œå†™äº†ä¸€å †çš„æµ‹è¯•ä»£ç ã€‚</p>

<p>è¿›å…¥æ­£é¢˜ï¼ŒSpring çš„äº‹åŠ¡çš„ä¼ æ’­ç‰¹æ€§åˆ†ä¸ºä»¥ä¸‹çš„ä¸ƒç§ï¼š</p>

<ul>
  <li>PROPAGATION_REQUIRED</li>
  <li>PROPAGATION_SUPPORTS</li>
  <li>PROPAGATION_MANDATORY</li>
  <li>PROPAGATION_REQUIRES_NEW</li>
  <li>PROPAGATION_NOT_SUPPORTED</li>
  <li>PROPAGATION_NEVER</li>
  <li>PROPAGATION_NESTED</li>
</ul>

<p>ä¸‹é¢ä¸€ç§ç§æ¥è§£é‡Šï¼š</p>

<h4 id="propagationrequired">PROPAGATION_REQUIRED</h4>

<p>é»˜è®¤çš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§ï¼Œé€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ç”¨è¿™ä¸ªäº‹åŠ¡ä¼ æ’­ç‰¹æ€§å°±å¯ä»¥äº†ã€‚å¦‚æœå½“å‰äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¼šæ–°åˆ›å»ºä¸€ä¸ªäº‹åŠ¡ã€‚å¦‚æœå½“å‰çš„äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­å·²ç»æœ‰ä¸€ä¸ªäº‹åŠ¡äº†ï¼Œé‚£ä¹ˆæ–°å¼€å¯çš„äº‹åŠ¡ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„é€»è¾‘äº‹åŠ¡èŒƒå›´ï¼Œä½†æ˜¯ä¼šå’ŒåŸæœ‰çš„äº‹åŠ¡å…±ç”¨ä¸€ä¸ªç‰©ç†äº‹åŠ¡ï¼Œæˆ‘ä»¬æš‚ä¸”ä¸å…³å¿ƒé€»è¾‘äº‹åŠ¡å’Œç‰©ç†äº‹åŠ¡çš„åŒºåˆ«ï¼Œå…ˆçœ‹çœ‹è¿™æ ·ä¼šå¯¼è‡´æ€æ ·çš„ä»£ç è¡Œä¸ºï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">txRollbackInnerTxRollbackPropagationRequires</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="nd">@Override</span>
</span><span class="line">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">transactionStatus</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span> <span class="s">&quot;Huang&quot;</span><span class="o">,</span>
</span><span class="line">                <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">            <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">                <span class="nd">@Override</span>
</span><span class="line">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">                    <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;Huang&quot;</span><span class="o">,</span> <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">                    <span class="c1">// å†…éƒ¨äº‹åŠ¡è®¾ç½®äº† setRollbackOnlyï¼Œ</span>
</span><span class="line">                    <span class="n">status</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">();</span>
</span><span class="line">                <span class="o">}</span>
</span><span class="line">            <span class="o">});</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç åœ¨ä¸€ä¸ªåµŒå¥—çš„äº‹åŠ¡å†…éƒ¨ï¼ˆå†…å¤–å±‚çš„äº‹åŠ¡éƒ½æ˜¯ PROPAGATION_REQUIRED çš„ï¼‰è®¾ç½®äº†å›æ»šï¼Œé‚£ä¹ˆå¯¹äºå¤–éƒ¨çš„äº‹åŠ¡æ¥è¯´ï¼Œå®ƒä¼šæ”¶åˆ°ä¸€ä¸ª <code>UnexpectedRollbackException</code>ï¼Œå› ä¸ºå†…éƒ¨çš„äº‹åŠ¡å’Œå¤–éƒ¨çš„äº‹åŠ¡æ˜¯å…±ç”¨ä¸€ä¸ªç‰©ç†äº‹åŠ¡çš„ï¼Œæ‰€ä»¥æ˜¾ç„¶å†…éƒ¨çš„äº‹åŠ¡å¿…ç„¶ä¼šå¯¼è‡´å¤–éƒ¨äº‹åŠ¡çš„å›æ»šï¼Œä½†æ˜¯å› ä¸ºè¿™ä¸ªå›æ»šå¹¶ä¸æ˜¯å¤–éƒ¨äº‹åŠ¡è‡ªå·±è®¾ç½®çš„ï¼Œæ‰€ä»¥å¤–å±‚äº‹åŠ¡å›æ»šçš„æ—¶å€™ä¼šéœ€è¦æŠ›å‡ºä¸€ä¸ª <code>UnexpectedRollbackException</code>ï¼Œè®©äº‹åŠ¡çš„è°ƒç”¨æ–¹çŸ¥é“è¿™ä¸ªå›æ»šå¹¶ä¸æ˜¯å¤–éƒ¨äº‹åŠ¡è‡ªå·±æƒ³è¦å›æ»šï¼Œæ˜¯å§‹æ–™æœªåŠçš„ã€‚</p>

<p>ä½†æ˜¯ï¼Œå¦‚æœå†…å±‚çš„äº‹åŠ¡ä¸æ˜¯é€šè¿‡è®¾ç½® <code>setRollbackOnly()</code> æ¥å›æ»šï¼Œè€Œæ˜¯æŠ›å‡ºäº† <code>RuntimeException</code> æ¥å›æ»šï¼Œé‚£ä¹ˆå¤–å±‚çš„äº‹åŠ¡æ¥æ”¶åˆ°äº†å†…å±‚æŠ›å‡ºçš„ <code>RuntimeException</code> ä¹Ÿä¼šè·Ÿç€å›æ»šï¼Œè¿™ä¸ªæ˜¯å¯ä»¥é¢„æ–™åˆ°çš„è¡Œä¸ºï¼Œæ‰€ä»¥ä¸ä¼šæœ‰ <code>UnexpectedRollbackException</code> ã€‚</p>

<h4 id="propagationsupports">PROPAGATION_SUPPORTS</h4>

<p>PROPAGATION_SUPPORTS çš„ç‰¹æ€§æ˜¯å¦‚æœäº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­å·²ç»å­˜åœ¨ä¸€ä¸ªäº‹åŠ¡ï¼Œé‚£ä¹ˆæ–°çš„äº‹åŠ¡ï¼ˆä¼ æ’­ç‰¹æ€§ä¸º PROPAGATION_SUPPORTSï¼‰å°±ä¼šå’ŒåŸæ¥çš„äº‹åŠ¡å…±ç”¨ä¸€ä¸ªç‰©ç†äº‹åŠ¡ï¼Œå…¶è¡Œä¸ºå’Œ PROPAGATION_REQUIRED ä¸€æ ·ã€‚ä½†æ˜¯ï¼Œå¦‚æœå½“å‰äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆ PROPAGATION_SUPPORTS å°±æŒ‰æ— äº‹åŠ¡çš„æ–¹å¼æ‰§è¡Œä»£ç ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">txRollbackInnerTxRollbackPropagationSupports</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">supportsTransactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="nd">@Override</span>
</span><span class="line">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span> <span class="s">&quot;Huang&quot;</span><span class="o">,</span>
</span><span class="line">                <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">            <span class="k">throw</span> <span class="k">new</span> <span class="nf">CustomRuntimeException</span><span class="o">();</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>çœ‹ä¸Šé¢è¿™æ®µä»£ç ï¼Œè™½ç„¶æˆ‘ä»¬åœ¨äº‹åŠ¡ï¼ˆPROPAGATION_SUPPORTS çš„ï¼‰ä¸­æŠ›å‡ºäº†ä¸€ä¸ª <code>RuntimeException</code>ï¼Œä½†æ˜¯å› ä¸ºå…¶äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰äº‹åŠ¡å­˜åœ¨ï¼Œæ‰€ä»¥è¿™æ®µä»£ç å®é™…ä¸Šæ˜¯ä»¥æ— äº‹åŠ¡çš„æ–¹å¼æ‰§è¡Œçš„ï¼Œå› æ­¤ä»£ç ä¸­çš„ <code>jdbcTemplate.update()</code> æ“ä½œä¹Ÿä¸ä¼šè¢«å›æ»šã€‚</p>

<h4 id="propagationmandatory">PROPAGATION_MANDATORY</h4>

<p>PROPAGATION_MANDATORY è¦æ±‚äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­å¿…é¡»å­˜åœ¨äº‹åŠ¡ï¼Œå¦‚æœäº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­å­˜åœ¨äº‹åŠ¡ï¼Œé‚£ä¹ˆå…¶è¡Œä¸ºå’Œ <code>PROPAGATION_REQUIRED</code> ä¸€æ ·ã€‚å¦‚æœå½“å‰äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æ²¡æœ‰äº‹åŠ¡ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡º <code>IllegalTransactionStateException</code>ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç å°±ä¼šè¿™æ ·ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">txRollbackInnerTxRollbackPropagationMandatory</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">mandatoryTransactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="nd">@Override</span>
</span><span class="line">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">transactionStatus</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span> <span class="s">&quot;Huang&quot;</span><span class="o">,</span>
</span><span class="line">                <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="propagationrequiresnew">PROPAGATION_REQUIRES_NEW</h4>

<p>PROPAGATION_REQUIRES_NEW æ— è®ºå½“å‰äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æœ‰æ²¡æœ‰äº‹åŠ¡ï¼Œéƒ½ä¼šå¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œå¹¶ä¸”å’ŒåŸæ¥çš„äº‹åŠ¡å®Œå…¨æ˜¯éš”ç¦»çš„ï¼Œå¤–å±‚äº‹åŠ¡çš„å›æ»šä¸ä¼šå½±å“åˆ°å†…å±‚çš„äº‹åŠ¡ï¼Œå†…å±‚äº‹åŠ¡çš„å›æ»šä¹Ÿä¸ä¼šå½±å“åˆ°å¤–å±‚çš„äº‹åŠ¡ï¼ˆ<strong>è¿™ä¸ªè¯´æ³•å¾—ç¨å¾®æ‰“ç‚¹æŠ˜æ‰£ï¼šå› ä¸ºå¦‚æœå†…å±‚æŠ›å‡º <code>RuntimeException</code> çš„è¯ï¼Œé‚£ä¹ˆå¤–å±‚è¿˜æ˜¯ä¼šæ”¶åˆ°è¿™ä¸ªå¼‚å¸¸å¹¶ä¸”è§¦å‘å›æ»š</strong>ï¼‰ï¼Œæˆ‘ä»¬åˆ†æä¸‹å‡ æ®µä»£ç ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">txRollbackInnerTxRollbackPropagationRequiresNew</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="nd">@Override</span>
</span><span class="line">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">transactionStatus</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">            <span class="n">requiresNewTransactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">                <span class="nd">@Override</span>
</span><span class="line">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">                    <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;Huang&quot;</span><span class="o">,</span> <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">                <span class="o">}</span>
</span><span class="line">            <span class="o">});</span>
</span><span class="line">
</span><span class="line">            <span class="c1">// å¤–éƒ¨äº‹åŠ¡å‘ç”Ÿå›æ»šï¼Œå†…éƒ¨äº‹åŠ¡åº”è¯¥ä¸å—å½±å“è¿˜æ˜¯èƒ½å¤Ÿæäº¤</span>
</span><span class="line">            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">();</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç å¤–å±‚çš„äº‹åŠ¡å›æ»šäº†ï¼Œä½†æ˜¯ä¸ä¼šå½±å“åˆ°å†…å±‚çš„äº‹åŠ¡çš„æäº¤ï¼Œå†…å±‚äº‹åŠ¡ä¸å—å¤–å±‚çš„äº‹åŠ¡çš„å½±å“ã€‚å†çœ‹ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">txRollbackInnerTxRollbackPropagationRequiresNew2</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="nd">@Override</span>
</span><span class="line">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">transactionStatus</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span> <span class="s">&quot;Huang&quot;</span><span class="o">,</span>
</span><span class="line">                <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">            <span class="c1">// Nested transaction committed.</span>
</span><span class="line">            <span class="n">requiresNewTransactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">                <span class="nd">@Override</span>
</span><span class="line">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">                    <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;Huang&quot;</span><span class="o">,</span> <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">                    <span class="c1">// å†…éƒ¨äº‹åŠ¡å‘ç”Ÿå›æ»šï¼Œä½†æ˜¯å¤–éƒ¨äº‹åŠ¡ä¸åº”è¯¥å‘ç”Ÿå›æ»š</span>
</span><span class="line">                    <span class="n">status</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">();</span>
</span><span class="line">                <span class="o">}</span>
</span><span class="line">            <span class="o">});</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç åœ¨å†…å±‚äº‹åŠ¡ä¸Šè®¾ç½®äº† <code>setRollbackOnly</code>ï¼Œå†…å±‚äº‹åŠ¡è‚¯å®šä¼šå›æ»šï¼Œä½†æ˜¯ç”±äºå†…å±‚äº‹åŠ¡å’Œå¤–å±‚äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œæ‰€ä»¥å¤–å±‚äº‹åŠ¡ä¸ä¼šè¢«å›æ»šã€‚å†çœ‹ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">txRollbackInnerTxRollbackPropagationRequiresNew3</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="nd">@Override</span>
</span><span class="line">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">transactionStatus</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span> <span class="s">&quot;Huang&quot;</span><span class="o">,</span>
</span><span class="line">                <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">            <span class="n">requiresNewTransactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">                <span class="nd">@Override</span>
</span><span class="line">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">                    <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;Huang&quot;</span><span class="o">,</span> <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">                    <span class="c1">// å†…éƒ¨äº‹åŠ¡æŠ›å‡º RuntimeExceptionï¼Œå¤–éƒ¨äº‹åŠ¡æ¥æ”¶åˆ°å¼‚å¸¸ï¼Œä¾æ—§ä¼šå‘ç”Ÿå›æ»š</span>
</span><span class="line">                    <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">();</span>
</span><span class="line">                <span class="o">}</span>
</span><span class="line">            <span class="o">});</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç åœ¨å†…å±‚äº‹åŠ¡æŠ›å‡ºäº†ä¸€ä¸ª <code>RuntimeException</code>ï¼Œè™½ç„¶å†…å±‚äº‹åŠ¡å’Œå¤–å±‚äº‹åŠ¡åœ¨äº‹åŠ¡ä¸Šæ˜¯éš”ç¦»ï¼Œä½†æ˜¯ <code>RuntimeException</code> æ˜¾ç„¶è¿˜ä¼šæŠ›åˆ°å¤–å±‚å»ï¼Œæ‰€ä»¥å¤–å±‚äº‹åŠ¡ä¹Ÿä¼šå‘ç”Ÿå›æ»šã€‚</p>

<h4 id="propagationnotsupported">PROPAGATION_NOT_SUPPORTED</h4>

<p>PROPAGATION_NOT_SUPPORTED ä¸ç®¡å½“å‰äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­æœ‰æ²¡æœ‰äº‹åŠ¡ï¼Œä»£ç éƒ½ä¼šåœ¨æŒ‰ç…§æ— äº‹åŠ¡çš„æ–¹å¼æ‰§è¡Œï¼Œçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">txRollbackInnerTxRollbackPropagationNotSupport</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="nd">@Override</span>
</span><span class="line">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">transactionStatus</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span> <span class="s">&quot;Huang&quot;</span><span class="o">,</span>
</span><span class="line">                <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">            <span class="n">notSupportedTransactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">                <span class="nd">@Override</span>
</span><span class="line">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">                    <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;Huang&quot;</span><span class="o">,</span> <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">                <span class="o">}</span>
</span><span class="line">            <span class="o">});</span>
</span><span class="line">            <span class="c1">// å¤–éƒ¨äº‹åŠ¡å›æ»šï¼Œä¸ä¼šæŠŠå†…éƒ¨çš„ä¹Ÿè¿ç€å›æ»š </span>
</span><span class="line">            <span class="n">transactionStatus</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">();</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>ä¸Šé¢è¿™æ®µä»£ç ä¸­è™½ç„¶å¤–éƒ¨äº‹åŠ¡å‘ç”Ÿäº†å›æ»šï¼Œä½†æ˜¯ç”±äºå†…éƒ¨çš„äº‹åŠ¡æ˜¯ PROPAGATION_NOT_SUPPORTEDï¼Œæ ¹æœ¬ä¸åœ¨å¤–å±‚çš„äº‹åŠ¡èŒƒå›´å†…ï¼Œæ‰€ä»¥å†…å±‚äº‹åŠ¡ä¸ä¼šå‘ç”Ÿå›æ»šã€‚</p>

<h4 id="propagationnever">PROPAGATION_NEVER</h4>

<p>PROPAGATION_NEVER å¦‚æœå½“å‰äº‹åŠ¡ä¸Šä¸‹æ–‡ä¸­å­˜åœ¨äº‹åŠ¡ï¼Œå°±ä¼šæŠ›å‡º <code>IllegalTransactionStateException</code> å¼‚å¸¸ï¼Œè‡ªå·±ä¹Ÿä¼šæŒ‰ç…§éäº‹åŠ¡çš„æ–¹å¼æ‰§è¡Œ</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">txRollbackInnerTxRollbackPropagationNever2</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="nd">@Override</span>
</span><span class="line">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">transactionStatus</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span> <span class="s">&quot;Huang&quot;</span><span class="o">,</span>
</span><span class="line">                <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">            <span class="n">neverTransactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">                <span class="nd">@Override</span>
</span><span class="line">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">                    <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;Huang&quot;</span><span class="o">,</span> <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">                <span class="o">}</span>
</span><span class="line">            <span class="o">});</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>æ¯”å¦‚ä¸Šé¢è¿™æ®µä»£ç ï¼Œåœ¨ä¸€ä¸ª PROPAGATION_REQUIRES é‡Œé¢åµŒå…¥äº†ä¸€ä¸ª PROPAGATION_NEVERï¼Œå†…å±‚å°±ä¼šæŠ›å‡ºä¸€ä¸ª <code>IllegalTransactionStateException</code>ï¼Œå¯¼è‡´å¤–å±‚äº‹åŠ¡è¢«å›æ»šã€‚</p>

<h4 id="propagationnested">PROPAGATION_NESTED</h4>

<p>PROPAGATION_NESTED åªèƒ½åº”ç”¨äºåƒ DataSource è¿™æ ·çš„äº‹åŠ¡ï¼Œå¯ä»¥é€šè¿‡åœ¨ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨å¼€å¯ä¸€ä¸ª PROPAGATION_NESTED è€Œè¾¾åˆ°ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨æœ‰å¤šä¸ªä¿å­˜ç‚¹çš„æ•ˆæœï¼Œä¸€ä¸ªå†…åµŒçš„äº‹åŠ¡å‘ç”Ÿå›æ»šï¼Œåªä¼šå›æ»šåˆ°å®ƒè‡ªå·±çš„ä¿å­˜ç‚¹ï¼Œå¤–å±‚äº‹åŠ¡è¿˜ä¼šç»§ç»­ï¼Œæ¯”å¦‚ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="nd">@Override</span>
</span><span class="line"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">txRollbackInnerTxRollbackPropagationNested</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="n">nestedTransactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="nd">@Override</span>
</span><span class="line">        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">transactionStatus</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span> <span class="s">&quot;Huang&quot;</span><span class="o">,</span>
</span><span class="line">                <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">            <span class="n">nestedTransactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="n">TransactionCallbackWithoutResult</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">                <span class="nd">@Override</span>
</span><span class="line">                <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doInTransactionWithoutResult</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">                    <span class="n">jdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="s">&quot;insert into user (name, password) values (?, ?)&quot;</span><span class="o">,</span>
</span><span class="line">                        <span class="s">&quot;Huang&quot;</span><span class="o">,</span> <span class="s">&quot;1111112&quot;</span><span class="o">);</span>
</span><span class="line">                    <span class="c1">// å†…éƒ¨äº‹åŠ¡è®¾ç½®äº† rollbackOnlyï¼Œå¤–éƒ¨äº‹åŠ¡åº”è¯¥ä¸å—å½±å“ï¼Œå¯ä»¥ç»§ç»­æäº¤</span>
</span><span class="line">                    <span class="n">status</span><span class="o">.</span><span class="na">setRollbackOnly</span><span class="o">();</span>
</span><span class="line">                <span class="o">}</span>
</span><span class="line">            <span class="o">});</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">});</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å†…å±‚çš„äº‹åŠ¡å‘ç”Ÿäº†å›æ»šï¼Œåªä¼šå›æ»šå…¶å†…éƒ¨çš„æ“ä½œï¼Œä¸ä¼šå½±å“åˆ°å¤–å±‚çš„äº‹åŠ¡ã€‚</p>

<h3 id="section">æ€»ç»“</h3>

<p>Spring çš„äº‹åŠ¡ä¼ æ’­ç‰¹æ€§ç§ç±»ç¹å¤šï¼Œå¤§å¤šæ•°éƒ½æ¥è‡ªäº EJB çš„äº‹åŠ¡ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å†™ä¸€äº›å°çš„ç¨‹åºæ¥æµ‹è¯• Spring å„ä¸ªäº‹åŠ¡ç‰¹æ€§çš„è¡Œä¸ºï¼ŒåŠ æ·±å°è±¡ï¼Œæˆ‘è‡ªå·±ä¹Ÿå†™äº†ä¸€ä¸ªå·¥ç¨‹ï¼Œé€šè¿‡å•å…ƒæµ‹è¯•å»æµ‹è¯•å„ä¸ªäº‹åŠ¡ä¼ æ’­ç‰¹æ€§çš„è¡Œä¸ºï¼Œå¤§å®¶æœ‰å…´è¶£çš„è¯ï¼Œå¯ä»¥ä¸‹è¿‡æ¥è·‘ä¸€ä¸‹ï¼š<a href="https://github.com/khotyn/spring-tx-test">https://github.com/khotyn/spring-tx-test</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/08/03/dumping-class-from-jvm/">ä» JVM ä¸­ Dump Class çš„å‡ ç§æ–¹æ³•</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-03T14:04:00+08:00" pubdate data-updated="true">Aug 3<span>rd</span>, 2013</time>
        
         | <a href="/blog/2013/08/03/dumping-class-from-jvm/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>å‰å‡ å¤©åœ¨ HotCode çš„ç”¨æˆ·ç¾¤é‡Œé¢ï¼Œæœ‰åŒå­¦é—®èµ·â€œå¦‚ä½•å°† JVM ä¸­çš„ class dump å‡ºæ¥â€ï¼Œå½“æ—¶æˆ‘ä¸‹æ„è¯†çš„å›ç­”å°±æ˜¯â€œå¯ä»¥åœ¨ JVM å¯åŠ¨çš„æ—¶å€™æŒ‚ä¸€ä¸ª agent ä¸Šå»ï¼Œç„¶åé€šè¿‡ Instrumentation API åœ¨ class åŠ è½½çš„æ—¶å€™åšæ‹¦æˆªï¼ŒæŠŠç±» dump å‡ºæ¥ã€‚â€ï¼Œä»Šå¤©æ— èŠåœ¨ç¿» <a href="http://weibo.com/rednaxelafx">R å¤§</a>çš„<a href="http://rednaxelafx.iteye.com/blog/727938">åšå®¢</a>çš„æ—¶å€™ï¼Œå‘ç°è¿˜å¯ä»¥é€šè¿‡ sa-jdi.jar é‡Œé¢çš„ä¸€ä¸ªç±»åš dumpï¼Œè¿™é‡Œå°±é›†ä¸­ä»‹ç»ä¸€ä¸‹è¿™å‡ ä¸ªæ–¹æ³•ï¼Œç„¶åä»‹ç»æˆ‘åœ¨ sa-jdi.jar åŸºç¡€ä¸Šæ”¹çš„ä¸€ä¸ªå°å·¥å…·ã€‚</p>

<h3 id="classloadergetresourceasstream">é‡‡ç”¨ classLoader.getResourceAsStream()</h3>

<p>å°†ä¸€ä¸ªç±»ä» JVM ä¸­ dump å‡ºæ¥ï¼Œæœ€ç®€å•çš„æ–¹æ³•å½“ç„¶å°±æ˜¯ç›´æ¥ä» jar åŒ…ä¸­æŠŠå¯¹åº”çš„ class æ–‡ä»¶æ‰¾åˆ°ï¼Œç„¶å dump å‡ºæ¥äº†ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>classLoader</code> çš„ <code>getResourceAsStream</code> æ¥åšï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">ClassLoader</span> <span class="n">loader</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
</span><span class="line"><span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">getResourceAsStream</span><span class="o">(</span><span class="s">&quot;com/khotyn/Test.class&quot;</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>æ‹¿åˆ° InputStream åï¼Œä½ å°±å¯ä»¥éšä¾¿ç©äº†ã€‚</p>

<p>è¿™ä¸ªæ–¹æ³•ç®€å•æ˜¯ç®€å•ï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œåœ¨æœ‰äº› Java ç¨‹åºä¸­ï¼Œç±»ä¸ä¸€å®šæ˜¯ä» Class æ–‡ä»¶ä¸­è¿‡æ¥ï¼Œæœ‰äº›æ˜¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„ï¼Œæœ‰äº›åˆ™åœ¨è½½å…¥åˆ° JVM ä¹‹å‰è¢«å¢å¼ºè¿‡ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•æœ‰äº›ç±»æ˜¯ dump ä¸å‡ºæ¥çš„ï¼Œæœ‰äº›ç±»åˆ™ dump å‡ºæ¥ä¸æ˜¯ä½ æƒ³è¦çš„ã€‚</p>

<h3 id="javaagent">é‡‡ç”¨ javaagent</h3>

<p>å¦å¤–ä¸€ä¸ªæ–¹æ³•æ˜¯é€šè¿‡åœ¨ JVM å¯åŠ¨çš„æ—¶å€™æŒ‚åœ¨ä¸€ä¸ª javaagentï¼Œç„¶åç”¨ Instrucmentation API åœ¨ç±»è¢«åŠ è½½åˆ°è™šæ‹Ÿæœºä¹‹å‰åšæ‹¦æˆªï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">khotyn</span><span class="o">.</span><span class="na">test</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">java.io.File</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.lang.instrument.ClassFileTransformer</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.lang.instrument.IllegalClassFormatException</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.lang.instrument.Instrumentation</span><span class="o">;</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">java.security.ProtectionDomain</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="nn">org.apache.commons.io.FileUtils</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="cm">/**</span>
</span><span class="line"><span class="cm"> * A demo to demonstrate how to use JVM ti to dump class file from JVM.</span>
</span><span class="line"><span class="cm"> * </span>
</span><span class="line"><span class="cm"> * @author khotyn.huangt 13-8-3 PM2:21</span>
</span><span class="line"><span class="cm"> */</span>
</span><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AgentMain</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">premain</span><span class="o">(</span><span class="n">String</span> <span class="n">agentArgs</span><span class="o">,</span> <span class="n">Instrumentation</span> <span class="n">inst</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">inst</span><span class="o">.</span><span class="na">addTransformer</span><span class="o">(</span><span class="k">new</span> <span class="n">ClassFileTransformer</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">
</span><span class="line">            <span class="nd">@Override</span>
</span><span class="line">            <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">transform</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span> <span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">Class</span><span class="o">&lt;?&gt;</span> <span class="n">classBeingRedefined</span><span class="o">,</span>
</span><span class="line">                                    <span class="n">ProtectionDomain</span> <span class="n">protectionDomain</span><span class="o">,</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">classfileBuffer</span><span class="o">)</span>
</span><span class="line">                                                                                              <span class="kd">throws</span> <span class="n">IllegalClassFormatException</span> <span class="o">{</span>
</span><span class="line">                <span class="k">try</span> <span class="o">{</span>
</span><span class="line">                    <span class="n">FileUtils</span><span class="o">.</span><span class="na">writeByteArrayToFile</span><span class="o">(</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/&quot;</span> <span class="o">+</span> <span class="n">className</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="sc">&#39;.&#39;</span><span class="o">,</span> <span class="sc">&#39;/&#39;</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;.class&quot;</span><span class="o">),</span>
</span><span class="line">                                                   <span class="n">classfileBuffer</span><span class="o">);</span>
</span><span class="line">                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">                    <span class="c1">// Quite</span>
</span><span class="line">                <span class="o">}</span>
</span><span class="line">                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">            <span class="o">}</span>
</span><span class="line">        <span class="o">});</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å°†ä¸Šé¢çš„ä»£ç æ‰“æˆä¸€ä¸ª jar åŒ…ï¼ˆ<em>æ³¨æ„æŠŠä¾èµ–çš„ apache commons.io ä¹Ÿæ‰“å…¥ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä¸‹è½½æˆ‘çš„ demo å·¥ç¨‹ï¼š<a href="http://pan.baidu.com/share/link?shareid=778648109&amp;uk=607430891">agentDumpClass.zip</a></em>ï¼‰ï¼Œç„¶ååœ¨ jar åŒ…çš„ <code>META-INF/MANIFEST.MF</code> ä¸­å¡«ä¸Šå¦‚ä¸‹çš„å†…å®¹ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">Manifest</span><span class="o">-</span><span class="nl">Version:</span> <span class="mf">1.0</span>
</span><span class="line"><span class="n">Boot</span><span class="o">-</span><span class="n">Class</span><span class="o">-</span><span class="nl">Path:</span> <span class="n">agentDump</span><span class="o">.</span><span class="na">jar</span>
</span><span class="line"><span class="n">Built</span><span class="o">-</span><span class="nl">By:</span> <span class="n">apple</span>
</span><span class="line"><span class="n">Build</span><span class="o">-</span><span class="nl">Jdk:</span> <span class="mf">1.7</span><span class="o">.</span><span class="mi">0</span><span class="n">_17</span>
</span><span class="line"><span class="n">Class</span><span class="o">-</span><span class="nl">Path:</span> <span class="n">lib</span><span class="o">/</span><span class="n">commons</span><span class="o">-</span><span class="n">io</span><span class="o">-</span><span class="mf">2.4</span><span class="o">.</span><span class="na">jar</span>
</span><span class="line"><span class="n">Premain</span><span class="o">-</span><span class="nl">Class:</span> <span class="n">com</span><span class="o">.</span><span class="na">khotyn</span><span class="o">.</span><span class="na">test</span><span class="o">.</span><span class="na">AgentMain</span>
</span><span class="line"><span class="n">Created</span><span class="o">-</span><span class="nl">By:</span> <span class="n">Apache</span> <span class="n">Maven</span>
</span><span class="line"><span class="n">Can</span><span class="o">-</span><span class="n">Redefine</span><span class="o">-</span><span class="nl">Classes:</span> <span class="kc">true</span>
</span><span class="line"><span class="n">Archiver</span><span class="o">-</span><span class="nl">Version:</span> <span class="n">Plexus</span> <span class="n">Archiver</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>ç„¶åä½ å°±å¯ä»¥æ‰§è¡Œç±»ä¼¼äºä¸‹é¢çš„å‘½ä»¤æ¥è¿›è¡Œ dump äº†ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">java</span> <span class="o">-</span><span class="nl">javaagent:</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">apple</span><span class="o">/</span><span class="n">workspace</span><span class="o">/</span><span class="n">agentDumpClass</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">agentDump</span><span class="o">.</span><span class="na">jar</span> <span class="n">Test</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>ç”±äº premain æ–¹æ³•æ˜¯åœ¨ java ç¨‹åºçš„ main æ–¹æ³•æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹æ³•å‡ ä¹å¯ä»¥æ‹¦æˆªåˆ°æ‰€æœ‰çš„ç±»ï¼Œå¦å¤–ï¼Œç”±äºæ³¨å†Œçš„ ClassFileTransformer æ˜¯ ClassLoader åŠ è½½ class ä¹‹åï¼ŒJVM å®šä¹‰ class ä¹‹å‰è¢«æ‰§è¡Œçš„ï¼Œæ‰€ä»¥æ— è®ºæ˜¯åœ¨è¿è¡Œæ—¶ç”Ÿæˆçš„ç±»ï¼Œè¿˜æ˜¯ç»è¿‡å¢å¼ºåçš„ç±»ï¼Œè¿™ä¸ªæ–¹æ³•éƒ½èƒ½å¤Ÿ dump å‡ºæ¥ï¼Œæ¯”ç¬¬ä¸€ç§æ–¹æ³•è¦å¼ºå¾ˆå¤šã€‚ç„¶è€Œè¿™ä¸ªæ–¹æ³•è¿˜æ˜¯æœ‰ä¸€äº›ç¼ºç‚¹ï¼š</p>

<ul>
  <li>éœ€è¦åœ¨ JVM å¯åŠ¨æ—¶å¢åŠ ç‰¹åˆ«çš„å‚æ•°ã€‚</li>
  <li>åªèƒ½éš class è¢«åŠ è½½è¿›è¡Œ dumpï¼Œä¸èƒ½éšæ—¶è¿›è¡Œ dump</li>
</ul>

<h3 id="sa-jdijar--classdump-">é‡‡ç”¨ sa-jdi.jar çš„ ClassDump å·¥å…·</h3>

<p>è¿™ä¸ªæ–¹å¼æ˜¯ R å¤§åœ¨åšå®¢ä¸­ä»‹ç»çš„æ–¹æ³•ï¼Œå¯ä»¥è¯´æ˜¯æœ€å¼ºå¤§çš„æ–¹æ³•ï¼Œä¸åƒå‰é¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥åœ¨ JVM è¿›ç¨‹å¤–æ‰§è¡Œï¼Œä¸”åƒ javaagent çš„é‚£ä¸ªæ–¹æ³•ä¸€æ ·ï¼Œéƒ½å¯ä»¥å°†è¿è¡Œæ—¶å’Œè¢«å¢å¼ºè¿‡çš„ç±» dump å‡ºæ¥ï¼Œéå¸¸æ–¹ä¾¿ï¼Œè‡³äºå…·ä½“çš„ç”¨æ³•å¤§å®¶å°±ç›´æ¥çœ‹ <a href="http://rednaxelafx.iteye.com/blog/727938">R å¤§çš„æ–‡ç« </a>å§ã€‚</p>

<h3 id="classdump">æ”¹è¿› ClassDump</h3>

<p>ClassDump å·¥å…·è™½ç„¶å¼ºå¤§ï¼Œä½†æ˜¯å‘½ä»¤ç•¥æ˜¾ç¹çï¼Œç‰¹åˆ«æ˜¯å½“ä½ åªéœ€è¦ dump ç‰¹å®šçš„ç±»çš„æ—¶å€™ï¼Œè¿˜éœ€è¦ä¸“é—¨å†™ä¸€ä¸ª ClassFilter çš„å®ç°ç±»ï¼Œè¿™ä¹ˆå¥½çš„å·¥å…·ï¼Œåº”è¯¥ç›´æ¥åšæˆå‘½ä»¤è¡Œå·¥å…·æ‰å¥½ï¼Œäºæ˜¯æˆ‘ä¿®æ”¹äº† ClassDump çš„ä»£ç ï¼Œè®©å®ƒå¯ä»¥æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼çš„æ–¹å¼æ¥å¯¹éœ€è¦ dump çš„ç±»è¿›è¡Œè¿‡æ»¤ï¼Œæ”¹è¿›åçš„ ClassDump æ”¾åœ¨äº†æˆ‘çš„ github ä»“åº“ä¸Šï¼š<a href="https://github.com/khotyn/tools">https://github.com/khotyn/tools</a></p>

<p>å¤§å®¶å¯ä»¥ç›´æ¥ç”¨ä¸‹é¢çš„æ–¹å¼æ¥ä½¿ç”¨è¿™ä¸ªæ”¹è¿›ç‰ˆï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">sudo</span> <span class="n">classDump</span> <span class="mi">17118</span> <span class="err">&#39;</span><span class="n">com</span><span class="o">.</span><span class="na">khotyn</span><span class="o">.*</span><span class="err">&#39;</span> <span class="n">dump</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>classDump è¿™ä¸ªå‘½ä»¤çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç›®æ ‡ JVM çš„ PIDï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºä½ æ‰€è¦ Dump å‡ºæ¥çš„ç±»ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°å¯é€‰ï¼Œæ˜¯ dump çš„ç›®å½•ã€‚</p>

<p>ä½†æ˜¯è¿™ä¸ªå·¥å…·æœ‰ä¸€ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯ç›®å‰åªèƒ½åœ¨ Mac ä¸‹ç”¨ï¼ˆå› ä¸ºæˆ‘ç”¨ Macï¼Œå‘µå‘µï¼Œæˆ‘æŠŠä¿®æ”¹åçš„ç±»ç›´æ¥æ‰“å…¥åˆ°äº† Mac çš„ jdk çš„ sa-jdi.jar ä¸‹é¢ï¼‰ï¼Œä¸è¿‡è¦åšå…¶ä»–çš„å¹³å°çš„ä¹Ÿå¾ˆç®€å•å•¦ï¼Œåªè¦æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ¥æ‰“åŒ…å‡ºè‡ªå·±çš„ sa-jdi.jar å°±å¯ä»¥ï¼š</p>

<ul>
  <li>ä¸‹è½½æˆ‘ä¿®æ”¹è¿‡çš„ä¸¤ä¸ªç±»ï¼š<a href="http://pan.baidu.com/share/link?shareid=780474506&amp;uk=607430891">ClassDump.class</a>ï¼Œ<a href="http://pan.baidu.com/share/link?shareid=782905423&amp;uk=607430891">RegexClassFilter.class</a></li>
  <li>ä» jdk ç›®å½•ä¸‹æ‹·è´ä¸€ä»½ sa-jdi.jar å‡ºæ¥</li>
  <li>ç”¨ä¸‹é¢çš„å‘½ä»¤å°†ä¿®æ”¹è¿‡çš„ä¸¤ä¸ªç±»æ‰“åˆ° sa-jdi.jar ä¸­å»ï¼š<code>jar uf sa-jdi.jar sun/jvm/hotspot/tools/jcore/ClassDump.class sun/jvm/hotspot/tools/jcore/RegexClassFilter.class</code></li>
  <li>ç„¶åé…åˆä»“åº“ä¸­çš„ classDump è„šæœ¬å°±å¯ä»¥ç”¨äº†ã€‚</li>
</ul>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/07/30/sed-part-two/">ã€ŒSed & Awkã€é˜…è¯»ç¬”è®°ä¹‹ Sed é«˜çº§å‘½ä»¤</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-30T21:41:00+08:00" pubdate data-updated="true">Jul 30<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/30/sed-part-two/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»‹ç»äº†ä¸€ä¸‹ <a href="../../../../2013/07/28/sed-and-awk-part-one/">sed çš„åŸºç¡€</a>ï¼ŒåŒ…æ‹¬æ‰§è¡Œæ–¹å¼ã€åœ°å€é€‰æ‹©å™¨ä»¥åŠåŸºæœ¬å‘½ä»¤ï¼Œåœ¨è¿™ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç»§ç»­æ¥äº†è§£ä¸€ä¸‹ sed çš„é«˜çº§å‘½ä»¤ï¼Œä¹‹æ‰€ä»¥ç§°å®ƒä»¬ä¸ºé«˜çº§å‘½ä»¤ï¼Œæ˜¯å› ä¸ºè¿™äº›å‘½ä»¤ä¼šæ”¹å˜ sed çš„æ‰§è¡Œæµï¼ŒåºŸè¯ä¸è¯´ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›å‘½ä»¤å§ï¼š</p>

<h3 id="section">é«˜çº§å‘½ä»¤</h3>

<h4 id="n-next">N (Next)</h4>

<p>è¿™é‡Œè¦ä»‹ç»çš„ç¬¬ä¸€ä¸ªå‘½ä»¤æ˜¯ <code>N</code>ï¼Œå®ƒå’Œæˆ‘ä»¬å‰é¢ä»‹ç»è¿‡çš„ <code>n</code> å‘½ä»¤å¾ˆåƒï¼Œä¹Ÿæ˜¯è¦è¯»å–ä¸‹ä¸€è¡Œçš„å†…å®¹ï¼Œä¸åŒçš„æ˜¯ï¼Œ<code>N</code> è¯»å–ä¸‹ä¸€è¡Œçš„å†…å®¹å¹¶ä¸”å°†è¿™äº›å†…å®¹é™„åŠ åˆ° pattern space å½“å‰çš„å†…å®¹åé¢ã€‚è¿™æ ·ï¼Œå½“ä½ éœ€è¦è¿ç€å¤„ç†å¤šè¡Œå†…å®¹çš„æ—¶å€™ï¼Œ<code>N</code> å‘½ä»¤å°±ä¼šç‰¹åˆ«æœ‰ç”¨ï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸‹é¢ä¸€æ®µæ–‡æœ¬ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line">one two three four
</span><span class="line">one two three 
</span><span class="line">four three two
</span><span class="line">three four</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å¦‚æœæˆ‘ä»¬è¦æŠŠ <code>two three four</code> æ›¿æ¢æˆ <code>2 3 4</code>ï¼Œæ³¨æ„ä¾‹å­ä¸­çš„ <code>two three four</code> å¯èƒ½åœ¨ä¸åŒçš„è¡Œä¸­ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ç”¨ <code>N</code> å‘½ä»¤æ¥å¤„ç†ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">N
</span><span class="line">s/\n/ /
</span><span class="line">s/two three four/2 3 4/</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¾“å‡ºçš„å†…å®¹ä¸ºï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">one 2 3 4 one two three
</span><span class="line">four three 2 3 4</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™ä¸ªç»“æœä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œä¸è¿‡çš„ç¡®æ˜¯ç¬¦åˆäº†ä¸Šé¢çš„ sed è„šæœ¬çš„æ‰§è¡Œç»“æœï¼š</p>

<ol>
  <li>é¦–å…ˆï¼Œsed è„šæœ¬è¯»å–äº†æ–‡æœ¬çš„ç¬¬ä¸€è¡Œï¼Œè¿™ä¸ªæ—¶å€™ pattern space ä¸­çš„å†…å®¹ä¸º <code>one two three four</code></li>
  <li>ç„¶å sed è„šæœ¬æ‰§è¡Œ N å‘½ä»¤ï¼Œå°†ä¸‹ä¸€è¡Œè¯»å–å¹¶é™„åŠ åˆ°å½“å‰çš„ pattern space å†…å®¹çš„åé¢ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œpattern space ä¸­çš„å†…å®¹å°±å˜ä¸º <code>one two three four\none two three</code></li>
  <li>ä¸‹ä¸€ä¸ªå‘½ä»¤ï¼Œå°†æ¢è¡Œç¬¦ <code>\n</code> æ›¿æ¢æˆä¸€ä¸ªç©ºæ ¼ï¼Œpattern space ä¸­çš„å†…å®¹ä¸º <code>one two three four one two three</code></li>
  <li>ç„¶åä¸‹ä¸€ä¸ªå‘½ä»¤ï¼Œå°† pattern space ä¸­çš„ <code>two three four</code> æ›¿æ¢æˆ <code>2 3 4</code>ï¼Œè¿™ä¸ªæ—¶å€™ pattern space ä¸­çš„å†…å®¹ä¸º <code>one 2 3 4 one two three</code></li>
  <li>åˆ°è¾¾è„šæœ¬çš„ç»“å°¾ï¼Œè¾“å‡º pattern space ä¸­çš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬è¾“å‡ºå†…å®¹çš„ç¬¬ä¸€è¡Œã€‚</li>
  <li>ç„¶å sed è„šæœ¬è¯»å–æ–‡æœ¬çš„ä¸‹ä¸€è¡Œï¼Œæ³¨æ„å› ä¸ºä¹‹å‰ç¬¬äºŒè¡Œå·²ç»è¢« <code>N</code> å‘½ä»¤è¯»å–äº†ï¼Œæ‰€ä»¥ sed è„šæœ¬å¼€å§‹è¯»å–ç¬¬ä¸‰è¡Œï¼Œä¾æ—§æŒ‰ç…§å‰é¢çš„å‘½ä»¤æ‰§è¡Œï¼Œæœ€åå°±è¾“å‡ºäº†è¾“å‡ºå†…å®¹ä¸­çš„ç¬¬äºŒè¡Œã€‚</li>
</ol>

<p>è™½ç„¶è¿™ä¸ªç»“æœä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ï¼Œä¸è¿‡ç®—æ˜¯äº†è§£äº† N çš„ä½œç”¨äº†ã€‚</p>

<h4 id="d-delete">D (Delete)</h4>

<p>åŒæ ·ï¼Œå‰é¢æˆ‘ä»¬ä»‹ç»è¿‡ <code>d</code> å‘½ä»¤ï¼Œå®ƒç”¨æ¥åˆ é™¤ pattern space ä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”è¯»å–ä¸‹ä¸€è¡Œåˆ° pattern space ä¸­ï¼Œsed è„šæœ¬ä¹Ÿéšä¹‹ä»å¤´å¼€å§‹æ‰§è¡Œã€‚<code>D</code> å‘½ä»¤å’Œ <code>d</code> å‘½ä»¤ç¨å¾®æœ‰ç‚¹ä¸åŒï¼Œ<code>D</code> å‘½ä»¤ä¼šåˆ é™¤ pattern space ä¸­çš„ç¬¬ä¸€è¡Œçš„å†…å®¹ï¼Œå®ƒä¸ä¼šä»æ–‡æœ¬ä¸­è¯»å–æ–°çš„è¡Œè¿›æ¥ï¼Œå½“ç„¶ sed è„šæœ¬è¿˜æ˜¯ä¼šä»å¤´å¼€å§‹æ‰§è¡Œï¼Œå¦‚æœæˆ‘ä»¬æœ‰è¿™ä¹ˆä¸€ä¸ªæ–‡æœ¬ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class=""><span class="line">blank
</span><span class="line">blank
</span><span class="line">
</span><span class="line">
</span><span class="line">blank
</span><span class="line">
</span><span class="line">blank
</span><span class="line">
</span><span class="line">
</span><span class="line">blank
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line">
</span><span class="line">blank</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™ä¸ªæ–‡æœ¬ä¸­çš„æœ‰äº›æ®µè½ä¹‹é—´æœ‰å¤šä¸ªç©ºè¡Œï¼Œæˆ‘ä»¬å¸Œæœ›æŠŠå¤šä½™çš„ç©ºè¡Œå»æ‰ï¼Œä¹Ÿå°±æ˜¯å¦‚æœæ®µè½ä¹‹é—´æœ‰å¤šä¸ªç©ºè¡Œï¼Œå°±åˆ æ‰åªå‰©ä¸‹ä¸€ä¸ªï¼Œæˆ‘ä»¬çš„ sed è„šæœ¬å¯ä»¥è¿™ä¹ˆå†™ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line">/^$/{
</span><span class="line">	N
</span><span class="line">	/^\n$/D
</span><span class="line">}
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™ä¸ªè„šæœ¬å…ˆåŒ¹é…å‡ºç©ºè¡Œï¼Œç„¶åè¯»å–ç©ºè¡Œçš„ä¸‹ä¸€è¡Œï¼Œå¦‚æœä¸¤è¡Œéƒ½æ˜¯ç©ºè¡Œçš„è¯ï¼Œå°±æŠŠ pattern space ä¸­çš„ç¬¬ä¸€ä¸ªç©ºè¡Œåˆ é™¤æ‰ï¼Œç„¶åç»§ç»­è¯»å–ä¸‹ä¸€è¡Œåˆ° pattern space ä¸­ï¼Œç»“æœå°±æ˜¯æŠŠå¤šä½™çš„ç©ºè¡Œéƒ½åˆ é™¤æ‰ï¼Œåªå‰©ä¸‹ä¸€ä¸ªç©ºè¡Œäº†ã€‚</p>

<h4 id="p-print">P (Print)</h4>

<p><code>P</code> å‘½ä»¤å’Œ <code>p</code> å‘½ä»¤ä¹Ÿç¨å¾®ä¸åŒï¼Œ<code>P</code> å‘½ä»¤ä¸åƒ <code>p</code> å‘½ä»¤é‚£æ ·ä¼šæŠŠ pattern space ä¸­çš„æ‰€æœ‰å†…å®¹æ‰“å°å‡ºæ¥ï¼Œå®ƒåªä¼šå°† pattern space çš„ç¬¬ä¸€è¡Œæ‰“å°å‡ºæ¥ï¼Œè¿™é‡Œå°±ä¸åšè¿‡å¤šçš„ä»‹ç»äº†ã€‚</p>

<h4 id="h-hold-h-hold-g-get-g-get-x-exchange">h (hold), H (Hold), g (get), G (Get), x (exchange)</h4>

<p>è¿™é‡Œé¢æœ‰äº”ä¸ªå‘½ä»¤ï¼Œä¹‹æ‰€ä»¥ä¸€èµ·ä»‹ç»æ˜¯å› ä¸ºï¼Œè¿™äº”ä¸ªå‘½ä»¤éƒ½æ˜¯æ“ä½œ hold space çš„ï¼Œä¹‹å‰æˆ‘ä»¬å·²ç»çŸ¥é“äº† pattern space äº†ï¼Œhold space å¯ä»¥è®¤ä¸ºå°±æ˜¯ä¸€ä¸ªå†…å®¹çš„ä¸´æ—¶å­˜æ”¾ç‚¹ï¼Œä½ å¯ä»¥å°† pattern space ä¸­çš„å†…å®¹æ”¾åˆ° hold space ä¸­ï¼Œç­‰åˆ°éœ€è¦ä½¿ç”¨çš„æ—¶å€™å†å°† hold space ä¸­çš„å†…å®¹æ‹¿å›åˆ° pattern space ä¸­ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™äº”ä¸ªå‘½ä»¤çš„ä½œç”¨å§ï¼š</p>

<ul>
  <li>hï¼šå°† pattern space ä¸­çš„å†…å®¹æ‹·è´åˆ° hold space ä¸­ï¼Œhold space ä¸­åŸæ¥çš„å†…å®¹ä¼šè¢«è¦†ç›–ã€‚</li>
  <li>Hï¼šå°† pattern space ä¸­çš„å†…å®¹æ·»åŠ åˆ° hold space å½“å‰å†…å®¹çš„åé¢ã€‚</li>
  <li>gï¼šå°† hold space ä¸­çš„å†…å®¹æ‹·è´åˆ° pattern space ä¸­ï¼Œpattern space ä¸­åŸæ¥çš„å†…å®¹å°†ä¼šè¢«è¦†ç›–ã€‚</li>
  <li>Gï¼šå°† hold space ä¸­çš„å†…å®¹æ·»åŠ åˆ° pattern space ä¸­ç›®å‰çš„å†…å®¹åé¢ã€‚</li>
  <li>xï¼šäº¤æ¢ pattern space å’Œ hold space ä¸­çš„å†…å®¹ã€‚</li>
</ul>

<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class=""><span class="line">1
</span><span class="line">
2
</span><span class="line">
11
</span><span class="line">
22
</span><span class="line">
111
</span><span class="line">
222</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>ç°åœ¨æˆ‘ä»¬è¦å°†ä¸Šé¢çš„ 1 å’Œ 2 çš„ä½ç½®è°ƒæ¢ï¼Œå°±æ˜¯å…ˆå‡ºç° 2 å†å‡ºç° 1ï¼Œæˆ‘ä»¬çš„è„šæœ¬å¯ä»¥è¿™ä¹ˆå†™ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class=""><span class="line">/1/{
</span><span class="line">	h
</span><span class="line">	d
</span><span class="line">}
</span><span class="line">/2/{
</span><span class="line">	G
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µè„šæœ¬å…ˆåŒ¹é… 1 æ‰€åœ¨çš„è¡Œï¼Œç„¶åæ”¾åˆ° hold space ä¸­ï¼Œå°† pattern space ä¸­çš„å†…å®¹æ¸…é™¤æ‰ï¼Œç„¶ååŒ¹é…åˆ° 2 æ‰€åœ¨çš„è¡Œï¼Œå°† hold space ä¸­çš„å†…å®¹æ·»åŠ åˆ° pattern space åé¢ï¼Œè¿™æ ·ï¼Œpattern space ä¸­å°±æ˜¯å…ˆæœ‰ 2ï¼Œå†æœ‰ 1 äº†ã€‚</p>

<p>æœ€åï¼Œæˆ‘ä»¬å¾—åˆ°çš„ç»“æœå°±æ˜¯ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class=""><span class="line">2
</span><span class="line">1
</span><span class="line">22
</span><span class="line">11
</span><span class="line">222
</span><span class="line">111</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="b">b</h4>

<p><code>b</code> å‘½ä»¤æ˜¯ä¸€ä¸ªè·³è½¬å‘½ä»¤ï¼Œå®ƒæ˜¯æ— æ¡ä»¶çš„ï¼Œå®ƒçš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">[address]b [label]</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>[label] æ˜¯è¦è·³è½¬åˆ°çš„æ ‡ç­¾ï¼Œä½ å¯ä»¥åœ¨ sed è„šæœ¬ä¸­ç”¨ <code>:</code> å¼€å¤´æ¥è¡¨ç¤ºä¸€ä¸ªæ ‡ç­¾ï¼Œæ¯”å¦‚ä¸‹é¢çš„ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">:start
</span><span class="line">s/start/end/g
</span><span class="line">b start</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å¦‚æœ <code>b</code> åé¢ä¸å¸¦å‚æ•°ï¼Œé‚£ä¹ˆå°±è¡¨ç¤ºç›´æ¥è·³åˆ°è„šæœ¬çš„æœ«å°¾äº†ã€‚</p>

<h4 id="t">t</h4>

<p>é™¤äº† <code>b</code> è¿™æ ·ä¸€ä¸ªè·³è½¬å‘½ä»¤ä»¥å¤–ï¼Œsed è¿˜æœ‰ä¸€ä¸ª <code>t</code> çš„æ¡ä»¶è·³è½¬å‘½ä»¤ï¼Œå¦‚æœåœ¨å½“å‰è¡Œæœ‰ä¸€ä¸ªæ›¿æ¢è¢«æˆåŠŸæ‰§è¡Œäº†ï¼Œé‚£ä¹ˆ <code>t</code> å°±ä¼šè·³è½¬åˆ°ç‰¹å®šçš„æ ‡ç­¾ä¸Šï¼Œå®ƒçš„è¯­æ³• <code>b</code> æ˜¯ç±»ä¼¼çš„ã€‚</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">[address]t [label]</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">:begin
</span><span class="line">s/start/end/
</span><span class="line">t begin</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ¡ <code>t</code> å‘½ä»¤åªæœ‰åœ¨å½“å‰è¡Œçš„ start æˆåŠŸè¢«æ›¿æ¢æˆ end çš„æ—¶å€™æ‰ä¼šè·³è½¬åˆ° :begin æ ‡ç­¾é‚£é‡Œã€‚</p>

<h3 id="section-1">æ€»ç»“</h3>

<p>sed çš„é«˜çº§å‘½ä»¤ç›¸å¯¹äºåŸºæœ¬å‘½ä»¤æ¥è¯´ä¸æ€ä¹ˆå¸¸ç”¨ï¼Œä½†æ˜¯åœ¨å¤„ç†ç‰¹å®šçš„é—®é¢˜çš„æ—¶å€™ï¼Œè¿™äº›å‘½ä»¤è¿˜æ˜¯å¾ˆæœ‰ç”¨çš„ã€‚ä¸è¿‡ï¼Œä¸ç®¡æ€ä¹ˆè¯´ï¼Œsed éƒ½ä¸æ˜¯ä¸€é—¨å®Œå¤‡çš„è¯­è¨€ï¼Œæ‰€ä»¥å…¶é€‚ç”¨çš„é—®é¢˜åŸŸä¹Ÿæ˜¯æ¯”è¾ƒæœ‰é™çš„ï¼Œsed æœ€å¤§çš„ä¼˜åŠ¿åœ¨äºé€è¡Œå¤„ç†æ–‡æœ¬ä¸Šï¼Œç”¨é€‚å½“çš„å·¥å…·å¤„ç†é€‚å½“çš„é—®é¢˜ï¼Œæ‰èƒ½å‘æŒ¥å‡ºå·¥å…·æœ€å¤§çš„å¨åŠ›ã€‚</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/07/28/sed-and-awk-part-one/">ã€ŒSed & Awkã€é˜…è¯»ç¬”è®°ä¹‹ Sed åŸºç¡€</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-28T16:39:00+08:00" pubdate data-updated="true">Jul 28<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/28/sed-and-awk-part-one/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>ä¹‹å‰å†™çš„ä¸€ç¯‡æ–‡ç« æœ‰æåˆ°é‡‡ç”¨ sed æ¥<a href="../../../../blog/2013/07/24/match-line-not-contain-a-string/">åŒ¹é…ä¸åŒ…å«è¿ç»­å­—ç¬¦ä¸²çš„è¡Œ</a>ï¼Œå¹³æ—¶åœ¨åšæ—¥å¿—åˆ†æçš„æ—¶å€™ä¹Ÿç»å¸¸è¦ç”¨åˆ° sedï¼Œä½†æ˜¯ä»…ä»…ç”¨äº† sed çš„å­—ç¬¦ä¸²æ›¿æ¢çš„åŠŸèƒ½ï¼Œæ²¡æœ‰ç³»ç»Ÿåœ°å»å­¦ä¹ è¿‡ sed ç”¨æ³•ï¼Œè¿™æ¬¡æ‰¾åˆ°ä¸€æœ¬å«<a href="http://book.douban.com/subject/1741933/">ã€Œsed &amp; awkã€</a>çš„ä¹¦ï¼Œä¾¿èŠ±æ—¶é—´å¯¹ sed åšäº†ç³»ç»Ÿçš„å­¦ä¹ ã€‚</p>

<h3 id="sed-">sed çš„æ‰§è¡Œæ–¹å¼</h3>

<p>è¦äº†è§£ sedï¼Œå¿…é¡»äº†è§£ sed çš„æ‰§è¡Œæ–¹å¼ï¼Œsed æ˜¯ä¸€ä¸ªè¡Œå¤„ç†å™¨ï¼Œè„±èƒäº <a href="http://www.gnu.org/software/ed/manual/ed_manual.html">ed</a>ï¼ˆed æ˜¯ä¸€ä¸ªè¡Œç¼–è¾‘å™¨ï¼Œawk å’Œ grep ä¹Ÿæ˜¯åŸºäº ed çš„ï¼‰ï¼Œç®€å•åœ°è¯´ï¼Œsed çš„æ‰§è¡Œæ–¹å¼æ˜¯è¿™æ ·çš„ï¼š<strong>sed ä¼šä»è¾“å…¥çš„æ–‡æœ¬ä¸­è¯»å–ä¸€è¡Œï¼Œæ”¾åˆ° pattern space ä¸­ï¼Œç„¶åç”¨ sed è„šæœ¬å»å¤„ç†ï¼Œå¤„ç†å®Œåç»§ç»­è¯»å–ä¸‹ä¸€è¡Œï¼Œç»§ç»­å¤„ç†ã€‚</strong></p>

<p>å‡è®¾æˆ‘ä»¬æœ‰ä¸‹é¢ä¸€æ®µæ–‡æœ¬éœ€è¦å¤„ç†ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class=""><span class="line">John Daggett, 341 King Road, Plymouth MA
</span><span class="line">Alice Ford, 22 East Broadway, Richmond VA
</span><span class="line">Orville Thomas, 11345 Oak Bridge Road, Tulsa OK
</span><span class="line">Terry Kalkas, 402 Lans Road, Beaver Falls PA
</span><span class="line">Eric Adams, 20 Post Road, Sudbury MA
</span><span class="line">Hubert Sims, 328A Brook Road, Roanoke VA
</span><span class="line">Amy Wilde, 334 Bayshore Pkwy, Mountain View CA
</span><span class="line">Sal Carpenter, 73 6th Street, Boston MA</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>æˆ‘ä»¬è¦æŠŠæ–‡æœ¬ä¸­çš„ CA æ›¿æ¢æˆ Californiaï¼ŒOK æ›¿æ¢æˆ Oklahomaï¼Œäºæ˜¯æˆ‘ä»¬å†™äº†ä¸‹é¢ä¸€æ®µ sed è„šæœ¬ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class=""><span class="line">s/CA/California/
</span><span class="line">s/OK/Oklahoma/</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>é‚£ä¹ˆ sed çš„æ‰§è¡Œæ–¹å¼æ˜¯è¿™æ ·çš„ï¼š</p>

<ol>
  <li>å…ˆè¯»å–ç¬¬ä¸€è¡Œ <code>John Daggett, 341 King Road, Plymouth MA</code> åˆ° pattern space</li>
  <li>ç„¶åæ‰§è¡Œè„šæœ¬çš„ç¬¬ä¸€è¡Œå‘½ä»¤ï¼Œå°†å…¶ä¸­çš„ CA æ›¿æ¢æˆ Californiaã€‚</li>
  <li>ç„¶åæ‰§è¡Œè„šæœ¬çš„ç¬¬äºŒè¡Œå‘½ä»¤ï¼Œå°†å…¶ä¸­çš„ OK æ›¿æ¢æˆ Oklahomaã€‚</li>
  <li>æ–‡æœ¬çš„ç¬¬ä¸€è¡Œå¤„ç†å®Œæ¯•ï¼Œç»§ç»­è¯»å–æ–‡æœ¬çš„ä¸‹ä¸€è¡Œã€‚</li>
  <li>ç»§ç»­ç¬¬ 2 æ­¥å’Œç¬¬ 3 æ­¥ã€‚</li>
</ol>

<p>å½“ç„¶ï¼Œè¿™åªæ˜¯å¤§éƒ¨åˆ†æƒ…å†µä¸‹ sed çš„æ‰§è¡Œæ–¹å¼ï¼Œsed çš„åŸºæœ¬å‘½ä»¤éƒ½æ˜¯æŒ‰ç…§è¿™ç§æ–¹å¼æ¥æ‰§è¡Œçš„ï¼Œä¸€äº›é«˜çº§å‘½ä»¤å¯ä»¥æ”¹å˜ sed çš„æ‰§è¡Œæµã€‚ä¸è¿‡åœ¨äº†è§£è¿™äº› sed å‘½ä»¤ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸‹ sed çš„åœ°å€é€‰æ‹©å™¨ï¼Œå®ƒæ˜¯å¾ˆå¤šå‘½ä»¤çš„ç»„æˆéƒ¨åˆ†ã€‚</p>

<h3 id="sed--1">sed çš„åœ°å€é€‰æ‹©å™¨</h3>

<p>é»˜è®¤çš„æƒ…å†µï¼Œsed è„šæœ¬ä¼šå¯¹æ–‡æœ¬çš„æ¯ä¸€è¡Œåšå¤„ç†ï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬åªå¸Œæœ›æˆ‘ä»¬çš„å‘½ä»¤ä½œç”¨äºç‰¹å®šçš„å‡ è¡Œï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ sed çš„åœ°å€é€‰æ‹©å™¨ï¼Œsed çš„åœ°å€é€‰æ‹©å™¨å¯ä»¥æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼ˆsed çš„æ­£åˆ™è¡¨è¾¾å¼æ€»æ˜¯æ”¾åœ¨ä¸¤ä¸ª <code>/</code> ä¸­é—´ï¼‰ï¼Œè¡Œå·ï¼Œæˆ–è€…åœ°å€ç¬¦å·ï¼ˆ<em>è¿™ä¸ªæ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿæˆ‘ä¹Ÿä¸æ¸…æ¥š</em>ï¼‰ï¼Œå…·ä½“çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p>

<ul>
  <li>å¦‚æœæ²¡æœ‰æŒ‡å®šåœ°å€é€‰æ‹©å™¨ï¼Œé‚£ä¹ˆå‘½ä»¤é»˜è®¤ä¼šåº”ç”¨åœ¨æ¯ä¸€è¡Œä¸Šã€‚</li>
  <li>å¦‚æœåªæœ‰ä¸€ä¸ªåœ°å€é€‰æ‹©å™¨ï¼Œé‚£ä¹ˆå‘½ä»¤ä¼šä½œç”¨åœ¨æ¯ä¸€ä¸ªç¬¦åˆè¿™ä¸ªåœ°å€é€‰æ‹©å™¨çš„è¡Œä¸Šã€‚</li>
  <li>å¦‚æœæ˜¯ä¸¤ä¸ªç”¨ <code>,</code> åˆ†å‰²çš„åœ°å€ï¼Œé‚£ä¹ˆå‘½ä»¤ä¼šå…ˆä½œç”¨åˆ°ç¬¬ä¸€ä¸ªç¬¦åˆç¬¬ä¸€ä¸ªåœ°å€é€‰æ‹©å™¨çš„è¡Œä¸Šï¼Œç„¶åç»§ç»­ä½œç”¨äºåç»­çš„è¡Œï¼Œç›´åˆ°ï¼ˆåŒ…æ‹¬ï¼‰ç¬¬ä¸€ä¸ªç¬¦åˆç¬¬äºŒä¸ªåœ°å€é€‰æ‹©å™¨çš„è¡Œä¸ºæ­¢ã€‚</li>
  <li>åœ°å€é€‰æ‹©å™¨åé¢å¯ä»¥è·Ÿä¸Šä¸€ä¸ª <code>!</code>ï¼Œè¡¨ç¤ºåå‘é€‰æ‹©ã€‚</li>
</ul>

<p>å¦å¤–åœ¨ä¸€ä¸ªåœ°å€é€‰æ‹©å™¨ä¸­ï¼Œä½ å¯ä»¥ç”¨ä¸€å¯¹ <code>{}</code> å°†å¤šä¸ªå‘½ä»¤åŒ…å«åœ¨å…¶ä¸­ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class=""><span class="line">/^\.TS/,/^\.TE/{
</span><span class="line">     /^$/d
</span><span class="line">     s/^\.ps 10/.ps 8/
</span><span class="line">     s/^\.vs 12/.vs 10/
</span><span class="line">}
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™ä¸ª sed è„šæœ¬çš„ç¬¬ä¸€è¡Œå°±æ˜¯ä¸€ä¸ªåœ°å€é€‰æ‹©å™¨ï¼Œç”± <code>,</code> åˆ†å¼€çš„ä¸¤ä¸ªåœ°å€é€‰æ‹©å™¨ç»„æˆï¼Œéƒ½æ˜¯æ­£åˆ™è¡¨è¾¾å¼å½¢å¼çš„ï¼Œè¡¨ç¤ºåé¢ <code>{}</code> ä¸­çš„å‘½ä»¤ä¼šä»ç¬¬ä¸€ä¸ªä»¥ <code>.TS</code> å¼€å¤´çš„è¡Œä¸€ç›´ä½œç”¨åˆ°ç¬¬ä¸€ä¸ªä»¥ <code>.TE</code> å¼€å¤´çš„è¡Œä¸ºæ­¢ã€‚</p>

<h3 id="sed--2">sed çš„åŸºæœ¬å‘½ä»¤</h3>

<p>äº†è§£å®Œ sed çš„åœ°å€é€‰æ‹©å™¨åï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»§ç»­äº†è§£ sed çš„åŸºæœ¬å‘½ä»¤äº†ã€‚</p>

<h4 id="substitution">æ›¿æ¢ï¼ˆsubstitutionï¼‰</h4>

<p>sed çš„æ–‡æœ¬æ›¿æ¢å‘½ä»¤æ˜¯æˆ‘æœ€å¸¸ç”¨çš„å‘½ä»¤ï¼Œå®ƒçš„è¯­æ³•æ˜¯è¿™æ ·çš„ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">[address]s/pattern/replacement/flags</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å®ƒç”±è¿™å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p>

<ul>
  <li>æœ€å‰é¢æ˜¯ä¸€ä¸ªåœ°å€é€‰æ‹©å™¨ï¼Œæ˜¯å¯é€‰çš„ã€‚</li>
  <li>ç„¶ååé¢æ˜¯ä¸€ä¸ªå‘½ä»¤ <code>s</code>ï¼Œè¡¨ç¤ºæ˜¯æ›¿æ¢å‘½ä»¤ã€‚</li>
  <li>åé¢ç´§è·Ÿä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¡¨ç¤ºè¦è¢«æ›¿æ¢çš„æ–‡æœ¬ã€‚</li>
  <li>å†åé¢æ˜¯å¸Œæœ›æ›¿æ¢æˆçš„æ–‡æœ¬ã€‚</li>
  <li>æœ€åæ˜¯æ ‡è®°ä½ã€‚</li>
</ul>

<p>å…¶ä¸­æ ‡è®°ä½å¯ä»¥æ˜¯ï¼š</p>

<ul>
  <li>nï¼šä¸€ä¸ªä» 1 åˆ° 512 çš„æ•°å­—ï¼Œè¡¨ç¤ºåªæ›¿æ¢ç¬¬ n ä¸ªç¬¦åˆ pattern å­ä¸²ã€‚</li>
  <li>gï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œæ›¿æ¢å‘½ä»¤åªä¼šæ›¿æ¢ä¸€è¡Œä¸­ç¬¬ä¸€ä¸ªç¬¦åˆ pattern çš„å­ä¸²ï¼ŒåŠ ä¸Š <code>g</code> ä»¥åä¼šå°†è¡Œä¸­æ‰€æœ‰ç¬¦åˆ pattern çš„å­ä¸²éƒ½è¿›è¡Œæ›¿æ¢ã€‚</li>
  <li>pï¼šå°† pattern space ä¸­çš„å†…å®¹æ‰“å°å‡ºæ¥ã€‚</li>
  <li>w <em>file</em> ï¼šå°† pattern space ä¸­çš„å†…å®¹å†™åˆ°æ–‡ä»¶ä¸­ã€‚</li>
</ul>

<p>ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦å°†ç¬¬ä¸€ä¸ªä¾‹å­ä¸­çš„æœ€åä¸€è¡Œçš„ MA æ¢æˆ Massachusettsï¼Œå°±å¯ä»¥è¿™æ ·å†™ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$s/MA/Massachusetts/</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å…¶ä¸­çš„ <code>$</code> æ˜¯ä¸€ä¸ªåœ°å€é€‰æ‹©å™¨ï¼Œè¡¨ç¤ºæœ€åä¸€è¡Œã€‚</p>

<p>æ›¿æ¢å‘½ä»¤çš„æ›¿æ¢æ–‡æœ¬åŸºæœ¬ä¸Šå°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼š<code>\</code>ï¼Œ<code>&amp;</code> å’Œ <code>\n</code>ï¼Œå…¶ä¸­ï¼š</p>

<ul>
  <li><code>\</code>ï¼šè½¬ä¹‰ï¼Œè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ã€‚</li>
  <li><code>&amp;</code>ï¼šä»£è¡¨è¦è¢«æ›¿æ¢çš„æ–‡æœ¬ï¼Œä¹Ÿå°±æ˜¯ç¬¦åˆ pattern çš„å­ä¸²ã€‚</li>
  <li><code>\n</code>ï¼šå½“å‰é¢çš„æ­£åˆ™è¡¨è¾¾å¼ä¸­æœ‰æ•è·éƒ¨åˆ†çš„æ—¶å€™ï¼ˆå³ï¼Œæ­£åˆ™è¡¨è¾¾å¼çš„ <code>()</code> è¯­æ³•ï¼‰ï¼Œå¯ä»¥åœ¨æ›¿æ¢æ–‡æœ¬ä¸­ç”¨è¿™ç§åå‘å¼•ç”¨çš„æ–¹å¼è¿›è¡Œå¼•ç”¨ã€‚</li>
</ul>

<p>è¿™äº›ç‰¹æ®Šå­—ç¬¦åœ¨å½“ä½ éœ€è¦å°†åŒ¹é…çš„æ–‡æœ¬ä¸­çš„æŸäº›éƒ¨åˆ†æ”¾åˆ°æ›¿æ¢æ–‡æœ¬ä¸­çš„æ—¶å€™ä¼šç‰¹åˆ«æœ‰ç”¨ã€‚</p>

<h4 id="delete">åˆ é™¤ï¼ˆdeleteï¼‰</h4>

<p>åˆ é™¤å‘½ä»¤å¾ˆç®€å•ï¼Œå®ƒçš„è¯­æ³•æ˜¯ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">[address]d</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å‰é¢å¯ä»¥å¸¦ä¸€ä¸ªåœ°å€é€‰æ‹©å™¨ï¼Œåé¢æ˜¯ä¸€ä¸ª dï¼Œè¡¨ç¤ºåˆ é™¤å‘½ä»¤ï¼Œä¸¾ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬è¦ç­›é€‰å‡ºä¸åŒ…å« <code>abc</code> çš„è¡Œï¼Œå¯ä»¥è¿™æ ·å†™ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">/abc/d</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>æŠŠåŒ…å« abc çš„è¡Œå…¨éƒ¨éƒ½åˆ é™¤æ‰ï¼Œè¿™æ ·å°±ç­›é€‰å‡ºäº†ä¸åŒ…å« <code>abc</code> çš„è¡Œã€‚</p>

<h4 id="appendinsertchange">è¿½åŠ ï¼Œæ’å…¥å’Œå˜åŒ–ï¼ˆappendï¼Œinsertï¼Œchangeï¼‰</h4>

<p>è¿™ä¸‰ä¸ªå‘½ä»¤çš„ä½œç”¨åˆ†åˆ«æ˜¯ï¼šinsert å°†æä¾›çš„æ–‡æœ¬æ’å…¥åˆ° pattern space çš„å½“å‰è¡Œå‰é¢ï¼Œappend å°†æä¾›çš„æ–‡æœ¬è¿½åŠ åˆ° pattern space çš„å½“å‰è¡Œåé¢ï¼Œchange å‘½ä»¤æ›¿æ¢ pattern space ä¸­çš„å†…å®¹ï¼Œä¹‹æ‰€ä»¥å°†è¿™ä¸‰ä¸ªå‘½ä»¤æ”¾åˆ°ä¸€èµ·è¯´ï¼Œæ˜¯å› ä¸ºè¿™ä¸‰ä¸ªå‘½ä»¤éœ€è¦å°†æä¾›çš„æ–‡æœ¬æ”¾åœ¨å‘½ä»¤çš„ç¬¬äºŒè¡Œï¼Œå®ƒä»¬çš„è¯­æ³•åˆ†åˆ«æ˜¯è¿™æ ·çš„ï¼š</p>

<p>append</p>

<pre><code>[line-address]a\
text
</code></pre>

<p>insert</p>

<pre><code>[line-address]i\

text
</code></pre>

<p>changae</p>

<pre><code>[address]c\

text
</code></pre>

<p>æ¥ä¸€ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬æœ‰ä¸‹é¢ä¸€æ®µæ–‡æœ¬ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class=""><span class="line">I want to see @f1(what will happen) if we put the
</span><span class="line">font change commands @f1(on a set of lines).
</span><span class="line">If I understand things (correctly), the @f1(third) line causes problems. (No?).
</span><span class="line">Is this really the case, or is it (maybe) just something else?
</span><span class="line">Let's test having two on a line @f1(here) and @f1(there) as
</span><span class="line">well as one that begins on one line and ends @f1(somewhere
</span><span class="line">on another line).
</span><span class="line">What if @f1(it is here) on the line?
</span><span class="line">Another @f1(one).</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å‡è®¾ä¸ºäº†é˜…è¯»çš„ç¾è§‚ï¼Œæˆ‘ä»¬å¸Œæœ›æ®µè½ä¹‹é—´èƒ½å¤Ÿç©ºå‡ºä¸€è¡Œæ¥ï¼Œæ®µè½ç»“æŸçš„æ ‡è®°æˆ‘ä»¬æš‚ä¸”ç®€å•åœ°å‡è®¾ä»¥ <code>.</code> ç»“å°¾ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯åœ¨æ¯ä¸€ä¸ªä»¥ <code>.</code> ç»“å°¾çš„è¡Œåé¢å†æ’å…¥ä¸€è¡Œï¼Œé™¤äº†æœ€åä¸€è¡Œä¹‹å¤–ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ sed è„šæœ¬å°±å¯ä»¥è¿™ä¹ˆå†™ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$!{
</span><span class="line">	/\.$/a\
</span><span class="line">	\
</span><span class="line">
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>æ¥è¯´æ˜ä¸€ä¸‹è¿™æ®µè„šæœ¬ï¼Œç¬¬ä¸€è¡Œæ˜¯ä¸€ä¸ªåœ°å€é€‰æ‹©å™¨ï¼Œè¡¨ç¤ºé€‰æ‹©é™¤æœ€åä¸€è¡Œä»¥å¤–çš„è¡Œï¼Œå› ä¸ºæˆ‘ä»¬ä¸å¸Œæœ›åœ¨æœ€åä¸€ä¸ªæ®µè½åé¢ä¹ŸåŠ ä¸Šä¸€ä¸ªç©ºè¡Œï¼Œç„¶åé‡Œé¢çš„å‘½ä»¤æ˜¯å¯¹æ‰€æœ‰çš„ä»¥ <code>.</code> ç»“å°¾çš„è¡Œè¿ç”¨ a å‘½ä»¤å»è¿½åŠ ä¸€ä¸ªç©ºè¡Œã€‚</p>

<h4 id="list">åˆ—å‡ºï¼ˆlistï¼‰</h4>

<p>åˆ—å‡ºå‘½ä»¤å’Œæ‰“å°å‘½ä»¤å…¶å®å¾ˆåƒï¼Œä¸åŒçš„æ˜¯åˆ—å‡ºå‘½ä»¤ä¼šå°†ä¸å¯è§å­—ç¬¦ç»™åˆ—å‡ºæ¥ï¼Œæ¯”å¦‚ windows ä¸‹çš„æ¢è¡Œç¬¦ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸‹é¢ä¸€æ®µæ–‡æœ¬ï¼ˆ<code>^M</code> å¯ä»¥ç”¨ Ctrl+Vï¼Œç„¶å Ctrl+M æ¥è¾“å…¥ï¼‰ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">^M^M
</span><span class="line">^M
</span><span class="line">^M^M^M</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>ä¸Šé¢ä¸€æ®µæ–‡æœ¬ç”¨ <code>sed -n 'l'</code> è¾“å‡ºçš„å†…å®¹æ˜¯ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">\r\r$
</span><span class="line">\r$
</span><span class="line">\r\r\r$</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è€Œç”¨ <code>sed -n 'p'</code> è¾“å‡ºçš„å†…å®¹æ˜¯ä¸‰ä¸ªç©ºç©ºçš„è¡Œã€‚</p>

<p>åˆ—å‡ºå‘½ä»¤å°†ä¸å¯è§å­—ç¬¦æ‰“å°å‡ºæ¥äº†ï¼Œè€Œæ‰“å°å‘½ä»¤åˆ™æ²¡æœ‰ã€‚</p>

<h4 id="transform">è½¬æ¢ï¼ˆtransformï¼‰</h4>

<p>è½¬æ¢å‘½ä»¤å’Œæ›¿æ¢å‘½ä»¤å¬èµ·æ¥æ˜¯ä¸€æ ·ï¼Œä½†æ˜¯å®ƒä»¬è¿˜æ˜¯ä¸åŒçš„ï¼Œè½¬æ¢å‘½ä»¤å°±åƒæ˜¯å¤šä¸ª <code>tr</code> å‘½ä»¤ç”¨ç®¡é“è¿åœ¨ä¸€èµ·ä½œç”¨ä¸€æ ·ï¼Œå®ƒçš„è¯­æ³•æ˜¯ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">[address]y/abc/xyz/</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è½¬æ¢å‘½ä»¤çš„ä¸€ä¸ªä½¿ç”¨çš„åœºæ™¯å°±æ˜¯å¤§å°å†™çš„è½¬æ¢ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">y/abcdefghijklmnopqrstuvwxyz/ABCDEFGHIJKLMNOPQRSTUVWXYZ/</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>ä¸Šé¢è¿™ä¸ªå‘½ä»¤ä¼šå°†æ–‡æœ¬ä¸­æ‰€æœ‰çš„å°å†™å­—æ¯è½¬æ¢æˆå¤§å†™å­—æ¯ã€‚</p>

<h4 id="print">æ‰“å°ï¼ˆprintï¼‰</h4>

<p>æ‰“å°å‘½ä»¤å…¶å®å°±æ˜¯ä¸€ä¸ªç®€å•çš„ <code>p</code>ï¼Œå°† pattern space ä¸­çš„å†…å®¹æ‰“å°å‡ºæ¥ï¼Œæ¯”å¦‚ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$!p</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¡¨ç¤ºå°†é™¤æœ€åä¸€è¡Œä»¥å¤–çš„å†…å®¹å…¨éƒ¨æ‰“å°å‡ºæ¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤æƒ…å†µä¸‹ sed ä¼šå°† pattern space ä¸­çš„å†…å®¹éƒ½æ‰“å°å‡ºæ¥ï¼Œè¦å…³é—­è¿™ä¸ªåŠŸèƒ½ï¼Œå¯ä»¥åŠ ä¸Šä¸€ä¸ª <code>-n</code> å‚æ•°ï¼Œå°±åƒæˆ‘åœ¨ä»‹ç»åˆ—å‡ºå‘½ä»¤çš„æ—¶å€™åšçš„é‚£æ ·ã€‚</p>

<h4 id="section">æ‰“å°è¡Œå·</h4>

<p>æ‰“å°è¡Œå·ä¹Ÿå°±æ˜¯ä¸€ä¸ªç®€å•çš„ <code>=</code> å·ï¼Œå¤§å®¶å¯ä»¥å»è¯•ä¸€ä¸‹ï¼Œè¿™é‡Œä¸å†å¤šè®²äº†ã€‚</p>

<h4 id="next">ä¸‹ä¸€ä¸ªï¼ˆnextï¼‰</h4>

<p>next å‘½ä»¤æ˜¯ä¸€ä¸ª <code>n</code>ï¼Œå®ƒçš„ä½œç”¨æ˜¯å°† pattern space ä¸­çš„å†…å®¹ç«‹å³è¾“å‡ºï¼Œç„¶åå°†ä¸‹ä¸€è¡Œè¯»å…¥åˆ° pattern space ä¸­ï¼Œç„¶åç»§ç»­æ‰§è¡Œæ¥ä¸‹æ¥çš„å‘½ä»¤ï¼Œæ¯”å¦‚ï¼š</p>

<pre><code>/H1/{

n

/^$/d

}
</code></pre>

<p>å°±æ˜¯å…ˆåŒ¹é…åˆ°å«æœ‰ H1 çš„è¡Œï¼Œç„¶åå°†è¿™ä¸€è¡Œæ‰“å°å‡ºæ¥ï¼Œæ¥ç€è¯»å–ä¸‹ä¸€è¡Œåˆ° pattern spaceï¼Œå¦‚æœæ˜¯ç©ºçš„è¯ï¼Œå°±åˆ é™¤æ‰ã€‚</p>

<h4 id="readwrite">è¯»å–å’Œå†™å…¥æ–‡ä»¶ï¼ˆreadï¼Œwriteï¼‰</h4>

<p>sed çš„è¯»å–æ–‡ä»¶çš„åŠŸèƒ½å¯ä»¥å°†æ–‡ä»¶ä¸­çš„å†…å®¹è¿½åŠ åˆ° pattern space åé¢ï¼Œå‰é¢é‚£ä¸ªåœ¨æ®µè½åé¢æ·»åŠ ç©ºè¡Œçš„ä¾‹å­æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆåšï¼šé¦–å…ˆåˆ›å»ºä¸€ä¸ªåªåŒ…å«ä¸€ä¸ªç©ºè¡Œçš„æ–‡ä»¶å«åš tempï¼Œæ¥ç€æˆ‘ä»¬å°±å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„äº†ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class=""><span class="line">$!{
</span><span class="line">    /\.$/r temp
</span><span class="line">}</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>sed çš„å†™å…¥æ–‡ä»¶çš„åŠŸèƒ½å’Œè¯»å–æ–‡ä»¶çš„åŠŸèƒ½ç±»ä¼¼ï¼Œè¯­æ³•æ˜¯ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">[address]w file</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¡¨ç¤ºå°† pattern space ä¸­çš„å†…å®¹å†™å…¥åˆ°æ–‡ä»¶ã€‚</p>

<h4 id="quit">é€€å‡ºï¼ˆquitï¼‰</h4>

<p>sed çš„é€€å‡ºå‘½ä»¤æ˜¯è®© sed åœæ­¢è¯»å–æ–°çš„è¡Œï¼Œä¹Ÿåœæ­¢è¾“å‡ºï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯è®© sed é€€å‡ºäº†ï¼Œå®ƒçš„å‘½ä»¤çš„è¯­æ³•æ˜¯ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">[line-address]q</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å®ƒåªèƒ½ä½œç”¨åœ¨å•è¡Œçš„åœ°å€é€‰æ‹©å™¨ä¸Šã€‚</p>

<h3 id="section-1">æ€»ç»“</h3>

<p>sed çš„åŸºæœ¬å‘½ä»¤ç›¸å¯¹æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæœ€ä¸»è¦çš„è¿˜æ˜¯è¦ç”¨å¥½åœ°å€é€‰æ‹©å™¨ï¼Œåœ¨ä¸‹ä¸€ç¯‡ä¸­ï¼Œæˆ‘ä¼šä»‹ç»ä¸€äº› sed çš„é«˜çº§å‘½ä»¤ã€‚</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/07/24/match-line-not-contain-a-string/">å†è®ºå¦‚ä½•åŒ¹é…ä¸åŒ…å«è¿ç»­å­—ç¬¦ä¸²çš„è¡Œ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-24T22:35:00+08:00" pubdate data-updated="true">Jul 24<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/24/match-line-not-contain-a-string/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è®¨è®ºè¿‡å¦‚ä½•ä½¿ç”¨<a href="http://blog.khotyn.com/blog/2013/07/24/zero-width-assert/">ä½¿ç”¨é›¶å®½æ–­è¨€æ¥åŒ¹é…ä¸åŒ…å«è¿ç»­å­—ç¬¦ä¸²çš„è¡Œ</a>ï¼Œè¿™ä¸ªæ–¹æ³•é‡‡ç”¨äº†é›¶å®½æ–­è¨€è¿™ç§ä¸æ€ä¹ˆå¸¸è§çš„æ­£åˆ™è¡¨è¾¾å¼ç”¨æ³•ï¼Œè™½ç„¶è¡Œä¹‹æœ‰æ•ˆï¼Œä½†æ˜¯æ€»å½’æ˜¯ä¸ªéº»çƒ¦çš„æ–¹æ³•ï¼Œè€Œä¸”ï¼Œé›¶å®½æ–­è¨€å¾ˆå¤šçš„æ­£åˆ™è¡¨è¾¾å¼è§£é‡Šå™¨éƒ½ä¸æ”¯æŒï¼Œç”¨ grep çš„è¯ï¼Œå¾—åŠ ä¸Š -P å‚æ•°ï¼Œè®© grep é‡‡ç”¨ Perl çš„æ–¹å¼è§£é‡Šæ­£åˆ™è¡¨è¾¾å¼ï¼Œæ›´åŠ é—æ†¾çš„ä¸€ç‚¹æ˜¯ -P å‚æ•°ä¼¼ä¹åªæœ‰åœ¨ GNU çš„ç‰ˆæœ¬ä¸­æ‰æœ‰ï¼Œåœ¨æˆ‘çš„ Mac ä¸Šçš„ BSD ç‰ˆæœ¬çš„ grep ä¸­ï¼Œå¹¶æ²¡æœ‰è¿™ä¸ªå‚æ•°ã€‚</p>

<p>æ‰€å¹¸çš„æ˜¯ä»Šå¤©æ— èŠç¿»äº†ç¿» grep çš„ man pageï¼Œå‘ç°äº†å‡ ä¸ªæ›´åŠ æ–¹ä¾¿çš„æ–¹æ³•ä¹Ÿæ›´åŠ é€šç”¨çš„åŠæ³•ï¼Œåœ¨è¿™é‡Œå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼š</p>

<h3 id="grep--invert-match">grep çš„ invert match</h3>

<p>ä»Šå¤©ç¿» grep çš„ man pageï¼Œå‘ç°äº†ä¸€ä¸ª <code>-v</code> å‚æ•°ï¼Œå®ƒçš„è¯´æ˜æ˜¯è¿™æ ·çš„ï¼š</p>

<blockquote>
  <p>Selected lines are those not matching any of the specified patterns.</p>
</blockquote>

<p>æ­£æ˜¯æˆ‘ä»¬æƒ³è¦ï¼Œå¯ä»¥ä¼ å…¥ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ƒå¸®ä½ åŒ¹é…ä¸ç¬¦åˆè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼çš„è¡Œï¼Œè€Œä¸” <code>-v</code> å‚æ•°å„ä¸ª grep çš„ç‰ˆæœ¬éƒ½æ”¯æŒï¼Œæ— éœ€æ‹…å¿ƒæ¢ä¸ªç³»ç»Ÿå°±ä¸èƒ½ç”¨çš„æƒ…å†µã€‚</p>

<h3 id="sed--pattern-">é‡‡ç”¨ sed æ¥åˆ é™¤ç¬¦åˆæŸä¸ª pattern çš„è¡Œ</h3>

<p>å…¶å®ä¸ç”¨ grepï¼Œç”¨ sed ä¹Ÿå¯ä»¥åšåˆ°è¿™ä¸ªéœ€æ±‚ï¼Œsed æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¼ºå¤§çš„è¡Œå¤„ç†å·¥å…·ï¼Œsed å¯ä»¥ç”¨å¦‚ä¸‹çš„æ–¹å¼æŠŠç¬¦åˆæŸä¸ª pattern çš„è¡Œç»™åˆ é™¤æ‰ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">sed '/pattern/D'</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>æ€ä¹ˆæ ·ï¼Ÿä¹Ÿæ˜¯éå¸¸æ–¹ä¾¿çš„å§ï¼Œå®ƒå¯ä»¥åšåˆ°å’Œ grep ä¸€æ ·çš„åŠŸèƒ½ï¼Œéå¸¸æœ‰æ•ˆã€‚</p>

<h3 id="sed--pattern--1">é‡‡ç”¨ sed æ¥æ‰“å°ä¸ç¬¦åˆæŸä¸ª pattern çš„è¡Œ</h3>

<p>è¦ç”¨ sed æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…¶å®ä¸æ­¢ä¸Šé¢ä¸€ä¸ªæ–¹æ³•ï¼Œè¿˜å¯ä»¥ç”¨ä»¥ä¸‹çš„æ–¹æ³•æ¥åšï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">sed -n '/pattern/!p'</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è§£é‡Šä¸€ä¸‹è¿™æ®µ sed è„šæœ¬çš„ä½œç”¨ï¼Œé¦–å…ˆæ˜¯ <code>-n</code> å‚æ•°ï¼Œå¤§å®¶çŸ¥é“ sed çš„é»˜è®¤å°†å¤„ç†å’Œæ²¡æœ‰å¤„ç†è¿‡çš„è¡Œéƒ½å®šå‘åˆ°è¾“å‡ºæµä¸Šï¼Œè€Œ <code>-n</code> å‚æ•°æ˜¯ç”¨æ¥å…³é—­è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å½“ç„¶ä¸å¸Œæœ› sed å°†æ‰€æœ‰çš„è¡Œéƒ½æ‰“å°å‡ºæ¥ã€‚ç„¶åè„šæœ¬çš„å¼€å§‹æ˜¯ä¸€ä¸ªè¡Œçš„é€‰æ‹©å™¨ï¼Œå‰é¢æ˜¯ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼ˆsed çš„æ­£åˆ™è¡¨è¾¾å¼éƒ½æ˜¯æ”¾åœ¨ä¸¤ä¸ªæ–œæ ä¹‹é—´çš„ï¼‰ï¼Œåé¢çš„æ˜¯ä¸€ä¸ª<code>!</code>å·ï¼Œè¿™æ ·å°±è¡¨ç¤ºé€‰æ‹©åå‘é€‰æ‹©ï¼Œå³é€‰æ‹©ä¸ç¬¦åˆ pattern çš„è¡Œï¼Œç„¶åæœ€åæ˜¯ä¸€ä¸ª <code>p</code> å‘½ä»¤ï¼ŒæŠŠè¿™æ ·çš„è¡Œæ‰“å°å‡ºæ¥ï¼Œè¿™é‡Œçš„ pattern å½“ç„¶å¯ä»¥æ˜¯éœ€æ±‚ä¸­çš„é‚£ä¸ªè¿ç»­çš„å­—ç¬¦ä¸²ï¼Œè¿™æ ·ï¼Œæˆ‘ä»¬å°±è¾¾åˆ°äº†éœ€æ±‚çš„ç›®çš„äº†ã€‚</p>

<p>æ€»ç»“ä¸€ä¸‹ï¼Œæ¨èå¤§å®¶è¿˜æ˜¯ç”¨ grep çš„ invert match æˆ–è€… sed æ¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ï¼Œé›¶å®½æ–­è¨€åœ¨è§£å†³è¿™ä¸ªé—®é¢˜ä¸Šæ„Ÿè§‰æœ‰ç‚¹æ€é¸¡ç„‰ç”¨ç‰›åˆ€ï¼ˆ<strong>é›¶å®½æ–­è¨€è¿˜æœ‰å¾ˆå¤šé€‚ç”¨çš„åœºæ™¯ï¼Œä¸ä»…ä»…å¯ä»¥ç”¨æ¥è§£å†³è¿™ä¸ªé—®é¢˜</strong>ï¼‰ã€‚</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/07/24/zero-width-assert/">ä½¿ç”¨é›¶å®½æ–­è¨€æ¥åŒ¹é…ä¸åŒ…å«è¿ç»­å­—ç¬¦ä¸²çš„è¡Œ</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-24T16:34:00+08:00" pubdate data-updated="true">Jul 24<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/24/zero-width-assert/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>æœ€è¿‘åœ¨å·¥ä½œä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œæœ‰ N ä¸ªå­—ç¬¦ä¸²ï¼Œéœ€è¦ç”¨æ­£åˆ™è¡¨è¾¾å¼å»è¿‡æ»¤æ‰ä¸åŒ…å«æŸä¸€ä¸ªç‰¹å®šè¿ç»­å­—ç¬¦ä¸²(æ¯”å¦‚abc)çš„å­—ç¬¦ä¸²ã€‚</p>

<p>åœ¨ç½‘ä¸Šæœç½—äº†ä¸€å¤§æŠŠï¼Œæ‰¾åˆ°äº†åœ¨ Perl 5 çš„æ­£åˆ™è¡¨è¾¾å¼ä¸­æœ‰é›¶å®½æ–­è¨€è¿™ä¸ªä¸œè¥¿ï¼Œéå¸¸å¼ºå¤§ï¼Œå…ˆæ¥äº†è§£ä¸‹é›¶å®½æ–­è¨€å€’æ˜¯æ˜¯ä»€ä¹ˆï¼Ÿ</p>

<p>ç®€å•çš„è¯´ï¼Œé›¶å®½æ–­è¨€æ˜¯æŸ¥æ‰¾åœ¨æŸäº›å†…å®¹ä¹‹å‰æˆ–è€…ä¹‹åçš„ä¸œè¥¿ï¼Œè¿™æ ·è§£é‡Šèµ·æ¥å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼Œæˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸‹å‡ ç§é›¶å®½æ–­è¨€ï¼š</p>

<ul>
  <li>(?=exp)ï¼šè¿™ä¸ªé›¶å®½æ–­è¨€ç”¨æ¥æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®ä¹‹åèƒ½å¤ŸåŒ¹é…åˆ°è¡¨è¾¾å¼ expï¼Œè€ƒè™‘ä¸‹é¢è¿™ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ q(?=u)ï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼è¡¨ç¤ºåŒ¹é…åé¢çš„å­—ç¬¦æ˜¯ u çš„ q</li>
  <li>(?!exp)ï¼šè¿™ä¸ªé›¶å®½æ–­è¨€ç”¨æ¥æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®ä¹‹åä¸èƒ½å¤ŸåŒ¹é…åˆ°è¡¨è¾¾å¼ expï¼Œçœ‹ä¸‹é¢è¿™ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ q(?!u)ï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼è¡¨ç¤ºåŒ¹é…åé¢çš„å­—ç¬¦ä¸æ˜¯ u çš„ q</li>
  <li>(?&lt;=exp)ï¼šè¿™ä¸ªé›¶å®½æ–­è¨€ç”¨æ¥æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®ä¹‹å‰èƒ½å¤ŸåŒ¹é…åˆ°è¡¨è¾¾å¼ exp</li>
  <li>(?&lt;!exp)ï¼šè¿™ä¸ªé›¶å®½æ–­è¨€ç”¨æ¥æ–­è¨€è‡ªèº«å‡ºç°çš„ä½ç½®ä¹‹å‰ä¸èƒ½å¤ŸåŒ¹é…åˆ°è¡¨è¾¾å¼ exp</li>
</ul>

<p>åœ¨ç†è§£é›¶å®½æ–­è¨€çš„æ—¶å€™éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯å®ƒæ˜¯ä¸€ç§æ–­è¨€ï¼Œä¹Ÿå°±æ˜¯è¯´é›¶å®½æ–­è¨€åªä¼šå‘Šè¯‰ä½ åŒ¹ä¸åŒ¹é…ï¼Œä½†æ˜¯ä¸ä¼šâ€œæ¶ˆè´¹â€æ‰å­—ç¬¦ä¸²å†…çš„å†…å®¹ï¼Œæˆ‘ç”¨ä¸‹é¢çš„è¿™ä¸€ä¸ªä¾‹å­æ¥è§£é‡Šè¿™ä¸ªæƒ…å†µï¼š</p>

<p>æˆ‘ä»¬æœ‰ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ <code>k(?=h)otyn</code>ï¼Œç”¨å®ƒå»åŒ¹é… khotynï¼Œä¹çœ‹ä¸€ä¸‹è¿™ä¸ªåŒ¹é…æ˜¯ä¼šæˆåŠŸçš„ï¼Œä½†æ˜¯ç”±äºé›¶å®½æ–­è¨€åªåšæ–­è¨€ï¼Œè€Œä¸ä¼šâ€<strong>æ¶ˆè´¹</strong>â€œæ‰åŒ¹é…åˆ°çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥äº‹å®ä¸Šï¼Œè¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ˜¯ä¸€ä¸ªåé¢æ˜¯ h çš„ kï¼Œå¹¶ä¸”è¿™ä¸ª k çš„åé¢æ˜¯ otynï¼Œè¿™æ ·è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼æ— è®ºä»€ä¹ˆå­—ç¬¦ä¸²éƒ½ä¼šåŒ¹é…å¤±è´¥(æ­£ç¡®çš„åº”è¯¥æ˜¯ <code>k(?=h)hotyn</code>ï¼Œä¸è¿‡è¿™æ ·åŠ ä¸åŠ é›¶å®½æ–­è¨€å¹¶æ²¡æœ‰æ„ä¹‰)ã€‚</p>

<p>åœ¨ç†è§£é›¶å®½æ–­è¨€ä»¥åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä½•æ¥åŒ¹é…å‡ºä¸åŒ…å«â€œabcâ€çš„å­—ç¬¦ä¸²ï¼Œä¸‹é¢æ˜¯æˆ‘å†™å‡ºçš„ç»“æœï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">((?!abc).)+</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>é¦–å…ˆæˆ‘ä»¬çœ‹è¿™ä¸ªæ­£åˆ™è¡¨è¾¾å¼é‡Œé¢çš„ <code>(?!abc).</code> éƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†æ–­è¨€ä¸€ä¸ªç©ºå­—ç¬¦åé¢ä¸èƒ½å¤ŸåŒ¹é…åˆ°å­—ç¬¦ä¸²abcï¼Œå¹¶ä¸”è¿™ä¸ªç©ºå­—ç¬¦ä¸²åé¢æ˜¯ä¸€ä¸ªä»»æ„å­—ç¬¦ã€‚</p>

<p>æˆ‘ä»¬æ¥çœ‹ä¸‹ä¸‹é¢è¿™ä¸€æ®µä»£ç ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">Pattern</span> <span class="n">pattern</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Perl5Compiler</span><span class="o">().</span><span class="na">compile</span><span class="o">(</span><span class="s">&quot;((?!abc).)+&quot;</span><span class="o">);</span>
</span><span class="line"><span class="n">Perl5Matcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Perl5Matcher</span><span class="o">();</span>
</span><span class="line"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">&quot;abc&quot;</span><span class="o">,</span> <span class="n">pattern</span><span class="o">));</span>
</span><span class="line"><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">matches</span><span class="o">(</span><span class="s">&quot;abdas dfas&quot;</span><span class="o">,</span> <span class="n">pattern</span><span class="o">));</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç çš„æ‰§è¡Œç»“æœæ˜¯ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kc">false</span>
</span><span class="line"><span class="kc">true</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
<p>ç¬¬ä¸€ä¸ªåŒ¹é…å¤±è´¥æ˜¯å› ä¸ºåœ¨å­—ç¬¦ â€˜aâ€™ å‰é¢çš„ç©ºå­—ç¬¦åé¢åŒ¹é…åˆ°äº†å­—ç¬¦ä¸² â€œabcâ€ï¼Œå› æ­¤æ–­è¨€å¤±è´¥ï¼Œä»è€ŒåŒ¹é…å¤±è´¥ã€‚</p>

<p>ç¬¬äºŒä¸ªåŒ¹é…æˆåŠŸæ˜¯å› ä¸ºæ²¡æœ‰ä»»ä½•ä¸€ä¸ªç©ºå­—ç¬¦åé¢æœ‰å‡ºç° â€œabcâ€ ï¼Œå› ä¸ºåŒ¹é…æˆåŠŸã€‚</p>

<p>æœ€ååŠ ä¸Š + å·çš„åŸå› æ˜¯å› ä¸ºèƒ½å¤Ÿåšåˆ°å®Œå…¨åŒ¹é…ï¼Œå› ä¸ºä»»ä½•ä¸€ä¸ªå­—ç¬¦åªè¦å…¶æœ¬èº«ä¸æ˜¯ â€˜aâ€™ï¼Œå¹¶ä¸”åé¢ä¸æ˜¯ â€˜bcâ€™ï¼Œé‚£ä¹ˆå°±æ˜¯èƒ½å¤ŸåŒ¹é… â€œ(?!abc).â€ çš„ï¼Œå› æ­¤ï¼Œåªè¦ä¸€ä¸ªå­—ç¬¦ä¸²é‡Œé¢ä¸åŒ…å« abcï¼Œé‚£ä¹ˆå®ƒå°±èƒ½å¤Ÿå®Œå…¨åŒ¹é… ((?abc).)+</p>

<p><strong>PSï¼šè¿™ç‰‡æ–‡ç« å…¶å®æ˜¯å‰å‡ å¹´å†™çš„ï¼Œä¹‹å‰çš„åšå®¢è¢«å…³é—­äº†ï¼Œæ•°æ®ä¸¢äº†ï¼Œå¹¸å¥½å½“æ—¶åœ¨ Iteye ä¸Šè¿˜æœ‰ä¸€ä»½ï¼Œäºæ˜¯å°±è¿ç§»è¿‡æ¥ã€‚è¿™å‡ å¹´æˆ‘ç»å¸¸ç”¨è¿™ä¸ªæ–¹å¼æ¥åˆ†æçº¿ä¸ŠæœåŠ¡å™¨çš„æ—¥å¿—ï¼Œå¯ä»¥è¯´ï¼Œæœ‰äº†é›¶å®½æ–­è¨€ï¼Œçœå»äº†éå¸¸å¤šçš„éº»çƒ¦~ï¼Œå®šä½é—®é¢˜çš„é€Ÿåº¦ä¹Ÿå¿«äº†ä¸å°‘ï¼Œé›¶å®½æ–­è¨€çš„ç¡®æ˜¯ä¸€ä¸ªéå¸¸çŠ€åˆ©çš„ä¸œè¥¿ã€‚</strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/07/18/curl/">cURL ä½¿ç”¨ç®€ä»‹</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-18T22:05:00+08:00" pubdate data-updated="true">Jul 18<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/18/curl/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://curl.haxx.se/">cURL</a> è¿™ä¸ªç¥å™¨ç›¸ä¿¡å¾ˆå¤šäººéƒ½å·²ç»ç”¨è¿‡ï¼Œç®€å•åœ°è¯´ï¼ŒcURL å°±æ˜¯ä¸€ä¸ªå’ŒæœåŠ¡å™¨ç«¯é€šä¿¡çš„å·¥å…·ï¼Œè‡³äºç”¨ä»€ä¹ˆåè®®ï¼ŒcURL æ”¯æŒå„ç§å„æ ·çš„åè®®ï¼ŒåŒ…æ‹¬ HTTPï¼ŒFTPï¼ŒSMTP ç­‰ç­‰åè®®ï¼Œå¯ä»¥è¯´æ˜¯åº”æœ‰å°½æœ‰ã€‚</p>

<p>cURL çš„å¯ç”¨çš„å‚æ•°éå¸¸éå¸¸å¤šï¼Œä½ èƒ½æƒ³åˆ°çš„åŸºæœ¬ä¸Šéƒ½æœ‰ï¼Œä¸è¿‡ä¸€èˆ¬ä½¿ç”¨çš„å°±é‚£ä¹ˆå‡ ä¸ªå‚æ•°å§ï¼Œè¿™é‡Œå°±ä»‹ç»ä¸‹æˆ‘å¸¸å¸¸ç”¨åˆ°çš„ä¸¤ä¸ªï¼š</p>

<h3 id="post-">ä½¿ç”¨ Post æäº¤æ•°æ®</h3>

<p>æœ‰äº›æœåŠ¡å™¨ç«¯é™åˆ¶äº†ä½ åªèƒ½ç”¨ POST çš„æ–¹å¼æäº¤æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœä½ å°±ä¸èƒ½é€šè¿‡åœ¨ URL ä¸ŠåŠ ä¸Šå‚æ•°çš„æ–¹å¼æ¥æäº¤æ•°æ®äº†ï¼ŒcURL æä¾›äº†ä¸€ä¸ª <code>-d</code> å‚æ•°æ¥è®©ä½ å¯ä»¥ç”¨ POST çš„æ–¹å¼æŠŠæ•°æ®æäº¤ä¸Šå»ï¼Œä¾‹å¦‚ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">curl http://ka.178.com/receive/index -d "activity_id=3403"</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™ä¸ªè¯·æ±‚åªç”¨äº†ä¸€ä¸ªå‚æ•°ï¼Œå¤šä¸ªå‚æ•°å¯ä»¥ <code>&amp;</code> ç¬¦å·ä½œé“¾æ¥ã€‚</p>

<h3 id="cookie-">é™„å¸¦ Cookie åˆ°è¯·æ±‚ä¸Š</h3>

<p>ä½¿ç”¨ cURL çš„å¦ä¸€ä¸ªç»å¸¸éœ€è¦åšçš„äº‹æƒ…å°±æ˜¯éœ€è¦æ‹¿åˆ°ç”¨æˆ·çš„ç™»å½•ä¿¡æ¯ï¼Œè¿™äº›ç™»å½•ä¿¡æ¯å¾€å¾€æ”¾åœ¨ cookie é‡Œé¢ï¼Œè¿™æ ·ä½ å°±éœ€è¦æŠŠ cookie ä¿¡æ¯é™„åŠ åœ¨è¯·æ±‚ä¸Šæäº¤åˆ°æœåŠ¡å™¨ï¼Œè®©æœåŠ¡å™¨è®¤ä¸ºä½ æ˜¯å¤„äºç™»å½•çš„çŠ¶æ€ï¼ŒcURL æä¾›äº†ä¸€ä¸ª <code>--cookie</code> çš„å‚æ•°è®©ä½ å¯ä»¥é™„ä¸Š cookieï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">curl http://ka.178.com/receive/index -cookie "__utma=2582276614.13325.133516.3;"</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å¦‚æœå«Œ <code>--cookie</code> å¤ªé•¿ï¼Œå¯ä»¥ç”¨ <code>-b</code>ï¼Œ<code>-b</code> æ˜¯ <code>--cookie</code> çš„ç®€å†™ã€‚</p>

<h3 id="section">æ˜¾ç¤ºå‡ºè¯·æ±‚çš„å¤´ä¿¡æ¯</h3>

<p>å¯¹äºæœ‰ä¸€äº›è¯·æ±‚ï¼Œæ¯”å¦‚é‚£äº›è¿”å› 302 çŠ¶æ€ç çš„è¯·æ±‚ï¼ŒcURL é»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸ä¼šè¾“å‡ºä»»ä½•å†…å®¹çš„ï¼Œè¿™ç§è¯·æ±‚ä¸‹ï¼Œæˆ‘ä»¬å°±ä¸çŸ¥é“å®ƒæ˜¯è¿”å›äº† 200 è€Œå“åº”ä½“é‡Œé¢æ²¡æœ‰ä»»ä½•å†…å®¹è¿˜æ˜¯å› ä¸ºæ˜¯ 302 è€Œæ²¡æœ‰ä»»ä½•å†…å®¹å‘¢ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ <code>-D</code>ï¼ˆ<code>--dump-header</code>ï¼‰å‚æ•°æ¥æ˜¾ç¤ºè¯·æ±‚çš„å“åº”å¤´ï¼Œä¸è¿‡ <code>-D</code> å‚æ•°åé¢è¦åŠ ä¸Šä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³ç›´æ¥è¾“å‡ºåˆ°ç»ˆç«¯ï¼Œé‚£ä¹ˆå°±å¯ä»¥è¿™ä¹ˆå¹²ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class=""><span class="line">curl -D /dev/stdout http://xxxxx.com/xxxx.html</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>ç›´æ¥å°†å†…å®¹è¾“å‡ºåˆ°è®¾å¤‡ stdout ä¸‹å°±å¯ä»¥ï¼ˆæ„Ÿè°¢ Unixï¼Œä¸€åˆ‡çš†æ–‡ä»¶ï¼ï¼‰ã€‚</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/07/12/juc-concurrenthashmap/">Java å¹¶å‘ç¼–ç¨‹ä¹‹ ConcurrentHashMap</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-12T23:02:00+08:00" pubdate data-updated="true">Jul 12<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/12/juc-concurrenthashmap/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>æ­¤ç¯‡æ–‡ç« æ˜¯ä½œè€…ä¸¤å¹´å‰å‘å¸ƒåœ¨<a href="http://www.goldendoc.org/2011/06/juc_concurrenthashmap/">é»„é‡‘æ¡£</a>çš„æ–‡ç« ã€‚</strong></p>

<p>ConcurrentHashMap æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ Hash Tableï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯æä¾›äº†ä¸€ç»„å’Œ HashTable åŠŸèƒ½ç›¸åŒä½†æ˜¯çº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ã€‚ConcurrentHashMap å¯ä»¥åšåˆ°è¯»å–æ•°æ®ä¸åŠ é”ï¼Œå¹¶ä¸”å…¶å†…éƒ¨çš„ç»“æ„å¯ä»¥è®©å…¶åœ¨è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™èƒ½å¤Ÿå°†é”çš„ç²’åº¦ä¿æŒåœ°å°½é‡åœ°å°ï¼Œä¸ç”¨å¯¹æ•´ä¸ª ConcurrentHashMap åŠ é”ã€‚</p>

<h3 id="concurrenthashmap-">ConcurrentHashMap çš„å†…éƒ¨ç»“æ„</h3>

<p>ConcurrentHashMap ä¸ºäº†æé«˜æœ¬èº«çš„å¹¶å‘èƒ½åŠ›ï¼Œåœ¨å†…éƒ¨é‡‡ç”¨äº†ä¸€ä¸ªå«åš Segment çš„ç»“æ„ï¼Œä¸€ä¸ª Segment å…¶å®å°±æ˜¯ä¸€ä¸ªç±» Hash Table çš„ç»“æ„ï¼ŒSegment å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨æ•°ç»„ï¼Œæˆ‘ä»¬ç”¨ä¸‹é¢è¿™ä¸€å¹…å›¾æ¥çœ‹ä¸‹ ConcurrentHashMap çš„å†…éƒ¨ç»“æ„ï¼š</p>

<p><img src="https://pic.yupoo.com/goldendoc/Ba4GCFe1/nuEZ0.png" alt="image" /></p>

<p>ä»ä¸Šé¢çš„ç»“æ„æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°ï¼ŒConcurrentHashMap å®šä½ä¸€ä¸ªå…ƒç´ çš„è¿‡ç¨‹éœ€è¦è¿›è¡Œä¸¤æ¬¡ Hash æ“ä½œï¼Œç¬¬ä¸€æ¬¡ Hash å®šä½åˆ° Segmentï¼Œç¬¬äºŒæ¬¡ Hash å®šä½åˆ°å…ƒç´ æ‰€åœ¨çš„é“¾è¡¨çš„å¤´éƒ¨ï¼Œå› æ­¤ï¼Œè¿™ä¸€ç§ç»“æ„çš„å¸¦æ¥çš„å‰¯ä½œç”¨æ˜¯ Hash çš„è¿‡ç¨‹è¦æ¯”æ™®é€šçš„ HashMap è¦é•¿ï¼Œä½†æ˜¯å¸¦æ¥çš„å¥½å¤„æ˜¯å†™æ“ä½œçš„æ—¶å€™å¯ä»¥åªå¯¹å…ƒç´ æ‰€åœ¨çš„ Segment è¿›è¡ŒåŠ é”å³å¯ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ Segmentï¼Œè¿™æ ·ï¼Œåœ¨æœ€ç†æƒ³çš„æƒ…å†µä¸‹ï¼ŒConcurrentHashMap å¯ä»¥æœ€é«˜åŒæ—¶æ”¯æŒ Segment æ•°é‡å¤§å°çš„å†™æ“ä½œï¼ˆåˆšå¥½è¿™äº›å†™æ“ä½œéƒ½éå¸¸å¹³å‡åœ°åˆ†å¸ƒåœ¨æ‰€æœ‰çš„ Segment ä¸Šï¼‰ï¼Œæ‰€ä»¥ï¼Œé€šè¿‡è¿™ä¸€ç§ç»“æ„ï¼ŒConcurrentHashMap çš„å¹¶å‘èƒ½åŠ›å¯ä»¥å¤§å¤§çš„æé«˜ã€‚</p>

<h3 id="segment">Segment</h3>

<p>æˆ‘ä»¬å†æ¥å…·ä½“äº†è§£ä¸€ä¸‹Segmentçš„æ•°æ®ç»“æ„ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Segment</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="n">ReentrantLock</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
</span><span class="line">    <span class="kd">transient</span> <span class="kt">int</span> <span class="n">modCount</span><span class="o">;</span>
</span><span class="line">    <span class="kd">transient</span> <span class="kt">int</span> <span class="n">threshold</span><span class="o">;</span>
</span><span class="line">    <span class="kd">transient</span> <span class="kd">volatile</span> <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">table</span><span class="o">;</span>
</span><span class="line">    <span class="kd">final</span> <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¯¦ç»†è§£é‡Šä¸€ä¸‹ Segment é‡Œé¢çš„æˆå‘˜å˜é‡çš„æ„ä¹‰ï¼š</p>

<ul>
  <li>countï¼šSegment ä¸­å…ƒç´ çš„æ•°é‡</li>
  <li>modCountï¼šå¯¹ table çš„å¤§å°é€ æˆå½±å“çš„æ“ä½œçš„æ•°é‡ï¼ˆæ¯”å¦‚ put æˆ–è€… remove æ“ä½œï¼‰</li>
  <li>thresholdï¼šé˜ˆå€¼ï¼ŒSegment é‡Œé¢å…ƒç´ çš„æ•°é‡è¶…è¿‡è¿™ä¸ªå€¼ä¾æ—§å°±ä¼šå¯¹ Segment è¿›è¡Œæ‰©å®¹</li>
  <li>tableï¼šé“¾è¡¨æ•°ç»„ï¼Œæ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ä»£è¡¨äº†ä¸€ä¸ªé“¾è¡¨çš„å¤´éƒ¨</li>
  <li>loadFactorï¼šè´Ÿè½½å› å­ï¼Œç”¨äºç¡®å®š threshold</li>
</ul>

<h3 id="concurrenthashmap--1">ConcurrentHashMap çš„åˆå§‹åŒ–</h3>

<p>ä¸‹é¢æˆ‘ä»¬æ¥ç»“åˆæºä»£ç æ¥å…·ä½“åˆ†æä¸€ä¸‹ ConcurrentHashMap çš„å®ç°ï¼Œå…ˆçœ‹ä¸‹åˆå§‹åŒ–æ–¹æ³•ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="nf">ConcurrentHashMap</span><span class="o">(</span><span class="kt">int</span> <span class="n">initialCapacity</span><span class="o">,</span>
</span><span class="line">                         <span class="kt">float</span> <span class="n">loadFactor</span><span class="o">,</span> <span class="kt">int</span> <span class="n">concurrencyLevel</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(!(</span><span class="n">loadFactor</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">||</span> <span class="n">initialCapacity</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">concurrencyLevel</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
</span><span class="line">        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">();</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">concurrencyLevel</span> <span class="o">&gt;</span> <span class="n">MAX_SEGMENTS</span><span class="o">)</span>
</span><span class="line">        <span class="n">concurrencyLevel</span> <span class="o">=</span> <span class="n">MAX_SEGMENTS</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="c1">// Find power-of-two sizes best matching arguments</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">sshift</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">ssize</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">    <span class="k">while</span> <span class="o">(</span><span class="n">ssize</span> <span class="o">&lt;</span> <span class="n">concurrencyLevel</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="o">++</span><span class="n">sshift</span><span class="o">;</span>
</span><span class="line">        <span class="n">ssize</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">segmentShift</span> <span class="o">=</span> <span class="mi">32</span> <span class="o">-</span> <span class="n">sshift</span><span class="o">;</span>
</span><span class="line">    <span class="n">segmentMask</span> <span class="o">=</span> <span class="n">ssize</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">    <span class="k">this</span><span class="o">.</span><span class="na">segments</span> <span class="o">=</span> <span class="n">Segment</span><span class="o">.</span><span class="na">newArray</span><span class="o">(</span><span class="n">ssize</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">initialCapacity</span> <span class="o">&gt;</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">)</span>
</span><span class="line">        <span class="n">initialCapacity</span> <span class="o">=</span> <span class="n">MAXIMUM_CAPACITY</span><span class="o">;</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">initialCapacity</span> <span class="o">/</span> <span class="n">ssize</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">*</span> <span class="n">ssize</span> <span class="o">&lt;</span> <span class="n">initialCapacity</span><span class="o">)</span>
</span><span class="line">        <span class="o">++</span><span class="n">c</span><span class="o">;</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">cap</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">    <span class="k">while</span> <span class="o">(</span><span class="n">cap</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">)</span>
</span><span class="line">        <span class="n">cap</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">.</span><span class="na">segments</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span>
</span><span class="line">        <span class="k">this</span><span class="o">.</span><span class="na">segments</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Segment</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">cap</span><span class="o">,</span> <span class="n">loadFactor</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>CurrentHashMap çš„åˆå§‹åŒ–ä¸€å…±æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œä¸€ä¸ª initialCapacityï¼Œè¡¨ç¤ºåˆå§‹çš„å®¹é‡ï¼Œä¸€ä¸ª loadFactorï¼Œè¡¨ç¤ºè´Ÿè½½å‚æ•°ï¼Œæœ€åä¸€ä¸ªæ˜¯ concurrentLevelï¼Œä»£è¡¨ ConcurrentHashMap å†…éƒ¨çš„ Segment çš„æ•°é‡ï¼ŒConcurrentLevel ä¸€ç»æŒ‡å®šï¼Œä¸å¯æ”¹å˜ï¼Œåç»­å¦‚æœ ConcurrentHashMap çš„å…ƒç´ æ•°é‡å¢åŠ å¯¼è‡´ ConrruentHashMap éœ€è¦æ‰©å®¹ï¼ŒConcurrentHashMap ä¸ä¼šå¢åŠ  Segment çš„æ•°é‡ï¼Œè€Œåªä¼šå¢åŠ  Segment ä¸­é“¾è¡¨æ•°ç»„çš„å®¹é‡å¤§å°ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯æ‰©å®¹è¿‡ç¨‹ä¸éœ€è¦å¯¹æ•´ä¸ª ConcurrentHashMap åš rehashï¼Œè€Œåªéœ€è¦å¯¹ Segment é‡Œé¢çš„å…ƒç´ åšä¸€æ¬¡ rehash å°±å¯ä»¥äº†ã€‚</p>

<p>æ•´ä¸ª ConcurrentHashMap çš„åˆå§‹åŒ–æ–¹æ³•è¿˜æ˜¯éå¸¸ç®€å•çš„ï¼Œå…ˆæ˜¯æ ¹æ® concurrentLevel æ¥ new å‡º Segmentï¼Œè¿™é‡Œ Segment çš„æ•°é‡æ˜¯ä¸å°äº concurrentLevel çš„æœ€å¤§çš„ 2 çš„æŒ‡æ•°ï¼Œå°±æ˜¯è¯´ Segment çš„æ•°é‡æ°¸è¿œæ˜¯ 2 çš„æŒ‡æ•°ä¸ªï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯æ–¹ä¾¿é‡‡ç”¨ç§»ä½æ“ä½œæ¥è¿›è¡Œ hashï¼ŒåŠ å¿« hash çš„è¿‡ç¨‹ã€‚æ¥ä¸‹æ¥å°±æ˜¯æ ¹æ® intialCapacity ç¡®å®š Segment çš„å®¹é‡çš„å¤§å°ï¼Œæ¯ä¸€ä¸ª Segment çš„å®¹é‡å¤§å°ä¹Ÿæ˜¯ 2 çš„æŒ‡æ•°ï¼ŒåŒæ ·æ˜¯ä¸ºäº†åŠ å¿« hash çš„è¿‡ç¨‹ã€‚</p>

<p>è¿™è¾¹éœ€è¦ç‰¹åˆ«æ³¨æ„ä¸€ä¸‹ä¸¤ä¸ªå˜é‡ï¼Œåˆ†åˆ«æ˜¯ segmentShift å’Œ segmentMaskï¼Œè¿™ä¸¤ä¸ªå˜é‡åœ¨åé¢å°†ä¼šèµ·åˆ°å¾ˆå¤§çš„ä½œç”¨ï¼Œå‡è®¾æ„é€ å‡½æ•°ç¡®å®šäº† Segment çš„æ•°é‡æ˜¯ 2 çš„ n æ¬¡æ–¹ï¼Œé‚£ä¹ˆ segmentShift å°±ç­‰äº 32 å‡å» nï¼Œè€Œ segmentMask å°±ç­‰äº 2 çš„ n æ¬¡æ–¹å‡ä¸€ã€‚</p>

<h3 id="concurrenthashmap--get-">ConcurrentHashMap çš„ get æ“ä½œ</h3>

<p>å‰é¢æåˆ°è¿‡ ConcurrentHashMap çš„ get æ“ä½œæ˜¯ä¸ç”¨åŠ é”çš„ï¼Œæˆ‘ä»¬è¿™é‡Œçœ‹ä¸€ä¸‹å…¶å®ç°ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="n">V</span> <span class="nf">get</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">hash</span><span class="o">(</span><span class="n">key</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
</span><span class="line">    <span class="k">return</span> <span class="nf">segmentFor</span><span class="o">(</span><span class="n">hash</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">hash</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>çœ‹ç¬¬ä¸‰è¡Œï¼ŒsegmentFor è¿™ä¸ªå‡½æ•°ç”¨äºç¡®å®šæ“ä½œåº”è¯¥åœ¨å“ªä¸€ä¸ª segment ä¸­è¿›è¡Œï¼Œå‡ ä¹å¯¹ ConcurrentHashMap çš„æ‰€æœ‰æ“ä½œéƒ½éœ€è¦ç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬çœ‹ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">final</span> <span class="n">Segment</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">segmentFor</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">return</span> <span class="n">segments</span><span class="o">[(</span><span class="n">hash</span> <span class="o">&gt;&gt;&gt;</span> <span class="n">segmentShift</span><span class="o">)</span> <span class="o">&amp;</span> <span class="n">segmentMask</span><span class="o">];</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™ä¸ªå‡½æ•°ç”¨äº†ä½æ“ä½œæ¥ç¡®å®š Segmentï¼Œæ ¹æ®ä¼ å…¥çš„ hash å€¼å‘å³æ— ç¬¦å·å³ç§» segmentShift ä½ï¼Œç„¶åå’Œ segmentMask è¿›è¡Œä¸æ“ä½œï¼Œç»“åˆæˆ‘ä»¬ä¹‹å‰è¯´çš„ segmentShift å’Œ segmentMask çš„å€¼ï¼Œå°±å¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼šå‡è®¾ Segment çš„æ•°é‡æ˜¯ 2 çš„næ¬¡æ–¹ï¼Œæ ¹æ®å…ƒç´ çš„ hash å€¼çš„é«˜ n ä½å°±å¯ä»¥ç¡®å®šå…ƒç´ åˆ°åº•åœ¨å“ªä¸€ä¸ª Segment ä¸­ã€‚</p>

<p>åœ¨ç¡®å®šäº†éœ€è¦åœ¨å“ªä¸€ä¸ª segment ä¸­è¿›è¡Œæ“ä½œä»¥åï¼Œæ¥ä¸‹æ¥çš„äº‹æƒ…å°±æ˜¯è°ƒç”¨å¯¹åº”çš„ Segment çš„ get æ–¹æ³•ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">V</span> <span class="nf">get</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// read-volatile</span>
</span><span class="line">        <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">getFirst</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
</span><span class="line">        <span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">==</span> <span class="n">hash</span> <span class="o">&amp;&amp;</span> <span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">                <span class="n">V</span> <span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span><span class="line">                <span class="k">if</span> <span class="o">(</span><span class="n">v</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">                    <span class="k">return</span> <span class="n">v</span><span class="o">;</span>
</span><span class="line">                <span class="k">return</span> <span class="nf">readValueUnderLock</span><span class="o">(</span><span class="n">e</span><span class="o">);</span> <span class="c1">// recheck</span>
</span><span class="line">            <span class="o">}</span>
</span><span class="line">            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å…ˆçœ‹ç¬¬äºŒè¡Œä»£ç ï¼Œè¿™é‡Œå¯¹ count è¿›è¡Œäº†ä¸€æ¬¡åˆ¤æ–­ï¼Œå…¶ä¸­ count è¡¨ç¤º Segment ä¸­å…ƒç´ çš„æ•°é‡ï¼Œæˆ‘ä»¬å¯ä»¥æ¥çœ‹ä¸€ä¸‹ count çš„å®šä¹‰ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">transient</span> <span class="kd">volatile</span> <span class="kt">int</span> <span class="n">count</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>å¯ä»¥çœ‹åˆ° count æ˜¯ volatile çš„ï¼Œå®é™…ä¸Šè¿™é‡Œé‡Œé¢åˆ©ç”¨äº† volatile çš„è¯­ä¹‰ï¼š</p>

<blockquote>
  <p>å¯¹volatileå­—æ®µçš„å†™å…¥æ“ä½œhappens-beforeäºæ¯ä¸€ä¸ªåç»­çš„åŒä¸€ä¸ªå­—æ®µçš„è¯»æ“ä½œã€‚</p>
</blockquote>

<p>å› ä¸ºå®é™…ä¸Š putã€remove ç­‰æ“ä½œä¹Ÿä¼šæ›´æ–° count çš„å€¼ï¼Œæ‰€ä»¥å½“ç«äº‰å‘ç”Ÿçš„æ—¶å€™ï¼Œ volatile çš„è¯­ä¹‰å¯ä»¥ä¿è¯å†™æ“ä½œåœ¨è¯»æ“ä½œä¹‹å‰ï¼Œä¹Ÿå°±ä¿è¯äº†å†™æ“ä½œå¯¹åç»­çš„è¯»æ“ä½œéƒ½æ˜¯å¯è§çš„ï¼Œè¿™æ ·åé¢ get çš„åç»­æ“ä½œå°±å¯ä»¥æ‹¿åˆ°å®Œæ•´çš„å…ƒç´ å†…å®¹ã€‚</p>

<p>ç„¶åï¼Œåœ¨ç¬¬ä¸‰è¡Œï¼Œè°ƒç”¨äº† getFirst() æ¥å–å¾—é“¾è¡¨çš„å¤´éƒ¨ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">getFirst</span><span class="o">(</span><span class="kt">int</span> <span class="n">hash</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
</span><span class="line">    <span class="k">return</span> <span class="n">tab</span><span class="o">[</span><span class="n">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)];</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>åŒæ ·ï¼Œè¿™é‡Œä¹Ÿæ˜¯ç”¨ä½æ“ä½œæ¥ç¡®å®šé“¾è¡¨çš„å¤´éƒ¨ï¼Œhash å€¼å’Œ HashTable çš„é•¿åº¦å‡ä¸€åšä¸æ“ä½œï¼Œæœ€åçš„ç»“æœå°±æ˜¯ hash å€¼çš„ä½ n ä½ï¼Œå…¶ä¸­ n æ˜¯ HashTable çš„é•¿åº¦ä»¥ 2 ä¸ºåº•çš„ç»“æœã€‚</p>

<p>åœ¨ç¡®å®šäº†é“¾è¡¨çš„å¤´éƒ¨ä»¥åï¼Œå°±å¯ä»¥å¯¹æ•´ä¸ªé“¾è¡¨è¿›è¡Œéå†ï¼Œçœ‹ç¬¬ 4 è¡Œï¼Œå–å‡º key å¯¹åº”çš„ value çš„å€¼ï¼Œå¦‚æœæ‹¿å‡ºçš„ value çš„å€¼æ˜¯ nullï¼Œåˆ™å¯èƒ½è¿™ä¸ª keyï¼Œvalue å¯¹æ­£åœ¨ put çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå‡ºç°è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆå°±åŠ é”æ¥ä¿è¯å–å‡ºçš„ value æ˜¯å®Œæ•´çš„ï¼Œå¦‚æœä¸æ˜¯ nullï¼Œåˆ™ç›´æ¥è¿”å› valueã€‚</p>

<h3 id="concurrenthashmap--put-">ConcurrentHashMap çš„ put æ“ä½œ</h3>

<p>çœ‹å®Œäº† get æ“ä½œï¼Œå†çœ‹ä¸‹ put æ“ä½œï¼Œput æ“ä½œçš„å‰é¢ä¹Ÿæ˜¯ç¡®å®š Segment çš„è¿‡ç¨‹ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œç›´æ¥çœ‹å…³é”®çš„ segment çš„ put æ–¹æ³•ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">V</span> <span class="nf">put</span><span class="o">(</span><span class="n">K</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="n">V</span> <span class="n">value</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">onlyIfAbsent</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">lock</span><span class="o">();</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">count</span><span class="o">;</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span><span class="n">c</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="o">)</span> <span class="c1">// ensure capacity</span>
</span><span class="line">            <span class="n">rehash</span><span class="o">();</span>
</span><span class="line">        <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
</span><span class="line">        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span><span class="line">        <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">first</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
</span><span class="line">        <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
</span><span class="line">        <span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">!=</span> <span class="n">hash</span> <span class="o">||</span> <span class="o">!</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)))</span>
</span><span class="line">            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">        <span class="n">V</span> <span class="n">oldValue</span><span class="o">;</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">oldValue</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span><span class="line">            <span class="k">if</span> <span class="o">(!</span><span class="n">onlyIfAbsent</span><span class="o">)</span>
</span><span class="line">                <span class="n">e</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">        <span class="k">else</span> <span class="o">{</span>
</span><span class="line">            <span class="n">oldValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">            <span class="o">++</span><span class="n">modCount</span><span class="o">;</span>
</span><span class="line">            <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">key</span><span class="o">,</span> <span class="n">hash</span><span class="o">,</span> <span class="n">first</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
</span><span class="line">            <span class="n">count</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span> <span class="c1">// write-volatile</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">        <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">        <span class="n">unlock</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>é¦–å…ˆå¯¹ Segment çš„ put æ“ä½œæ˜¯åŠ é”å®Œæˆçš„ï¼Œç„¶ååœ¨ç¬¬äº”è¡Œï¼Œå¦‚æœ Segment ä¸­å…ƒç´ çš„æ•°é‡è¶…è¿‡äº†é˜ˆå€¼ï¼ˆç”±æ„é€ å‡½æ•°ä¸­çš„ loadFactor ç®—å‡ºï¼‰è¿™éœ€è¦è¿›è¡Œå¯¹ Segment æ‰©å®¹ï¼Œå¹¶ä¸”è¦è¿›è¡Œ rehashï¼Œå…³äº rehash çš„è¿‡ç¨‹å¤§å®¶å¯ä»¥è‡ªå·±å»äº†è§£ï¼Œè¿™é‡Œä¸è¯¦ç»†è®²äº†ã€‚</p>

<p>ç¬¬ 8 å’Œç¬¬ 9 è¡Œçš„æ“ä½œå°±æ˜¯ getFirst çš„è¿‡ç¨‹ï¼Œç¡®å®šé“¾è¡¨å¤´éƒ¨çš„ä½ç½®ã€‚</p>

<p>ç¬¬ 11 è¡Œè¿™é‡Œçš„è¿™ä¸ª while å¾ªç¯æ˜¯åœ¨é“¾è¡¨ä¸­å¯»æ‰¾å’Œè¦ put çš„å…ƒç´ ç›¸åŒ key çš„å…ƒç´ ï¼Œå¦‚æœæ‰¾åˆ°ï¼Œå°±ç›´æ¥æ›´æ–°æ›´æ–° key çš„ valueï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™è¿›å…¥ 21 è¡Œè¿™é‡Œï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„ HashEntry å¹¶ä¸”æŠŠå®ƒåŠ åˆ°æ•´ä¸ª Segment çš„å¤´éƒ¨ï¼Œç„¶åå†æ›´æ–° count çš„å€¼ã€‚</p>

<h3 id="concurrenthashmap--remove-">ConcurrentHashMap çš„ remove æ“ä½œ</h3>

<p>Remove æ“ä½œçš„å‰é¢ä¸€éƒ¨åˆ†å’Œå‰é¢çš„ get å’Œ put æ“ä½œä¸€æ ·ï¼Œéƒ½æ˜¯å®šä½ Segment çš„è¿‡ç¨‹ï¼Œç„¶åå†è°ƒç”¨ Segment çš„ remove æ–¹æ³•ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">V</span> <span class="nf">remove</span><span class="o">(</span><span class="n">Object</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">hash</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">lock</span><span class="o">();</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">        <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span>
</span><span class="line">        <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
</span><span class="line">        <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">hash</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">tab</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span><span class="line">        <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">first</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">];</span>
</span><span class="line">        <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span>
</span><span class="line">        <span class="k">while</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">hash</span> <span class="o">!=</span> <span class="n">hash</span> <span class="o">||</span> <span class="o">!</span><span class="n">key</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">key</span><span class="o">)))</span>
</span><span class="line">            <span class="n">e</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">        <span class="n">V</span> <span class="n">oldValue</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">            <span class="n">V</span> <span class="n">v</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
</span><span class="line">            <span class="k">if</span> <span class="o">(</span><span class="n">value</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">value</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">v</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">                <span class="n">oldValue</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
</span><span class="line">                <span class="c1">// All entries following removed node can stay</span>
</span><span class="line">                <span class="c1">// in list, but all preceding ones need to be</span>
</span><span class="line">                <span class="c1">// cloned.</span>
</span><span class="line">                <span class="o">++</span><span class="n">modCount</span><span class="o">;</span>
</span><span class="line">                <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">newFirst</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span><span class="line">                <span class="k">for</span> <span class="o">(</span><span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">first</span><span class="o">;</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">e</span><span class="o">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">)</span>
</span><span class="line">                    <span class="n">newFirst</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashEntry</span><span class="o">&lt;</span><span class="n">K</span><span class="o">,</span><span class="n">V</span><span class="o">&gt;(</span><span class="n">p</span><span class="o">.</span><span class="na">key</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">hash</span><span class="o">,</span>
</span><span class="line">                                                  <span class="n">newFirst</span><span class="o">,</span> <span class="n">p</span><span class="o">.</span><span class="na">value</span><span class="o">);</span>
</span><span class="line">                <span class="n">tab</span><span class="o">[</span><span class="n">index</span><span class="o">]</span> <span class="o">=</span> <span class="n">newFirst</span><span class="o">;</span>
</span><span class="line">                <span class="n">count</span> <span class="o">=</span> <span class="n">c</span><span class="o">;</span> <span class="c1">// write-volatile</span>
</span><span class="line">            <span class="o">}</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">        <span class="k">return</span> <span class="n">oldValue</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class="line">        <span class="n">unlock</span><span class="o">();</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>é¦–å…ˆ remove æ“ä½œä¹Ÿæ˜¯ç¡®å®šéœ€è¦åˆ é™¤çš„å…ƒç´ çš„ä½ç½®ï¼Œä¸è¿‡è¿™é‡Œåˆ é™¤å…ƒç´ çš„æ–¹æ³•ä¸æ˜¯ç®€å•åœ°æŠŠå¾…åˆ é™¤å…ƒç´ çš„å‰é¢çš„ä¸€ä¸ªå…ƒç´ çš„ next æŒ‡å‘åé¢ä¸€ä¸ªå°±å®Œäº‹äº†ï¼Œæˆ‘ä»¬ä¹‹å‰å·²ç»è¯´è¿‡ HashEntry ä¸­çš„ next æ˜¯ final çš„ï¼Œä¸€ç»èµ‹å€¼ä»¥åå°±ä¸å¯ä¿®æ”¹ï¼Œåœ¨å®šä½åˆ°å¾…åˆ é™¤å…ƒç´ çš„ä½ç½®ä»¥åï¼Œç¨‹åºå°±å°†å¾…åˆ é™¤å…ƒç´ å‰é¢çš„é‚£ä¸€äº›å…ƒç´ å…¨éƒ¨å¤åˆ¶ä¸€éï¼Œç„¶åå†ä¸€ä¸ªä¸€ä¸ªé‡æ–°æ¥åˆ°é“¾è¡¨ä¸Šå»ï¼Œçœ‹ä¸€ä¸‹ä¸‹é¢è¿™ä¸€å¹…å›¾æ¥äº†è§£è¿™ä¸ªè¿‡ç¨‹ï¼š</p>

<p><img src="https://pic.yupoo.com/goldendoc/Ba3OfBv8/medish.jpg" alt="image" /></p>

<p>å‡è®¾é“¾è¡¨ä¸­åŸæ¥çš„å…ƒç´ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç°åœ¨è¦åˆ é™¤å…ƒç´  3ï¼Œé‚£ä¹ˆåˆ é™¤å…ƒç´  3 ä»¥åçš„é“¾è¡¨å°±å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>

<p><img src="https://pic.yupoo.com/goldendoc/Ba3OfPQE/medish.jpg" alt="image" /></p>

<h3 id="concurrenthashmap--size-">ConcurrentHashMap çš„ size æ“ä½œ</h3>

<p>åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æ¶‰åŠåˆ°çš„æ“ä½œéƒ½æ˜¯åœ¨å•ä¸ª Segment ä¸­è¿›è¡Œçš„ï¼Œä½†æ˜¯ ConcurrentHashMap æœ‰ä¸€äº›æ“ä½œæ˜¯åœ¨å¤šä¸ª Segment ä¸­è¿›è¡Œï¼Œæ¯”å¦‚ size æ“ä½œï¼ŒConcurrentHashMap çš„ size æ“ä½œä¹Ÿé‡‡ç”¨äº†ä¸€ç§æ¯”è¾ƒå·§çš„æ–¹å¼ï¼Œæ¥å°½é‡é¿å…å¯¹æ‰€æœ‰çš„ Segment éƒ½åŠ é”ã€‚</p>

<p>å‰é¢æˆ‘ä»¬æåˆ°äº†ä¸€ä¸ª Segment ä¸­çš„æœ‰ä¸€ä¸ª modCount å˜é‡ï¼Œä»£è¡¨çš„æ˜¯å¯¹ Segment ä¸­å…ƒç´ çš„æ•°é‡é€ æˆå½±å“çš„æ“ä½œçš„æ¬¡æ•°ï¼Œè¿™ä¸ªå€¼åªå¢ä¸å‡ï¼Œsize æ“ä½œå°±æ˜¯éå†äº†ä¸¤æ¬¡ Segmentï¼Œæ¯æ¬¡è®°å½• Segment çš„ modCount å€¼ï¼Œç„¶åå°†ä¸¤æ¬¡çš„ modCount è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœç›¸åŒï¼Œåˆ™è¡¨ç¤ºæœŸé—´æ²¡æœ‰å‘ç”Ÿè¿‡å†™å…¥æ“ä½œï¼Œå°±å°†åŸå…ˆéå†çš„ç»“æœè¿”å›ï¼Œå¦‚æœä¸ç›¸åŒï¼Œåˆ™æŠŠè¿™ä¸ªè¿‡ç¨‹å†é‡å¤åšä¸€æ¬¡ï¼Œå¦‚æœå†ä¸ç›¸åŒï¼Œåˆ™å°±éœ€è¦å°†æ‰€æœ‰çš„ Segment éƒ½é”ä½ï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªéå†äº†ï¼Œå…·ä½“çš„å®ç°å¤§å®¶å¯ä»¥çœ‹ ConcurrentHashMap çš„æºç ï¼Œè¿™é‡Œå°±ä¸è´´äº†ã€‚</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/07/12/juc-condition/">Java å¹¶å‘ç¼–ç¨‹ J.U.C ä¹‹ Condition</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-12T07:36:00+08:00" pubdate data-updated="true">Jul 12<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/12/juc-condition/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>æ­¤ç¯‡æ–‡ç« æ˜¯ä½œè€…ä¸¤å¹´å‰å‘å¸ƒåœ¨<a href="http://www.goldendoc.org/2011/06/juc_condition/">é»„é‡‘æ¡£</a>çš„æ–‡ç« ã€‚</strong></p>

<p>åœ¨ä¸Šä¸€ç¯‡ä¸­ï¼Œæˆ‘ä»¬äº†è§£äº†ä¸‹ <a href="http://blog.khotyn.com/blog/2013/07/10/juc-lock-acquire-release/">J.U.C çš„é”çš„è·å–ä¸é‡Šæ”¾çš„è¿‡ç¨‹</a>ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸»è¦é€šè¿‡åœ¨ A.Q.S ä¸­ç»´æŒä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—æ¥å®ç°ï¼Œå…¶ä¸­æˆ‘ä»¬ä¹Ÿæåˆ°äº†ï¼Œåœ¨ A.Q.S ä¸­é™¤äº†ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª Condition é˜Ÿåˆ—ï¼Œåœ¨äº†è§£ Condition é˜Ÿåˆ—ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹ Condition æ˜¯æ€ä¹ˆå›äº‹ï¼š</p>

<blockquote>
  <p>The synchronizer framework provides a ConditionObject class for use by synchronizers that maintain exclusive synchronization and conform to the Lock interface. Any number of condition objects may be attached to a lock object, providing classic monitor-style await, signal, and signalAll operations, including those with timeouts, along with some inspection and monitoring methods.</p>
</blockquote>

<p>ä¸Šé¢çš„è¿™ä¸€æ®µå†…å®¹æ‘˜è‡ª Doug Lea çš„ <a href="http://gee.cs.oswego.edu/dl/papers/aqs.pdf">AQS è®ºæ–‡</a>ï¼Œä»ä¸Šé¢è¿™ä¸€æ®µè¯å¯ä»¥çœ‹å‡ºï¼ŒCondition ä¸»è¦æ˜¯ä¸ºäº†åœ¨ J.U.C æ¡†æ¶ä¸­æä¾›å’Œ Java ä¼ ç»Ÿçš„ç›‘è§†å™¨é£æ ¼çš„ waitï¼Œnotify å’Œ notifyAll æ–¹æ³•ç±»ä¼¼çš„åŠŸèƒ½ï¼Œé‚£ä¹ˆå…ˆæ¥è§£é‡Šä¸€ä¸‹è¿™ä¸‰ä¸ªæ–¹æ³•çš„ä½œç”¨ï¼š</p>

<ul>
  <li>Object.wait() æ–¹æ³•ï¼šä½¿å½“å‰çº¿ç¨‹é‡Šæ”¾ Object ä¸Šçš„ç›‘è§†å™¨å¹¶ä¸”æŒ‚èµ·ï¼Œç›´åˆ°æœ‰å¦å¤–çš„çº¿ç¨‹è°ƒç”¨ Object.notify() æ–¹æ³•æˆ–è€… Object.notifyAll() æ–¹æ³•å”¤é†’å½“å‰çº¿ç¨‹ï¼Œå½“è¢«å”¤é†’åï¼ŒObject.wait() æ–¹æ³•ä¼šå°è¯•é‡æ–°è·å–ç›‘è§†å™¨ï¼ŒæˆåŠŸè·å–åç»§ç»­å¾€ä¸‹æ‰§è¡Œã€‚æ³¨æ„ Object.wait() æ–¹æ³•åªæœ‰åœ¨å½“å‰çº¿ç¨‹æŒæœ‰ Object çš„ç›‘è§†å™¨çš„æ—¶å€™æ‰èƒ½å¤Ÿè°ƒç”¨ï¼Œä¸ç„¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li>
  <li>Object.notify() æ–¹æ³•ï¼šç”¨äºå”¤é†’å¦å¤–ä¸€ä¸ªè°ƒç”¨äº† Object.wait() æ–¹æ³•çš„çº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤šä¸ªéƒ½è°ƒç”¨äº† Object.wait() æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šé€‰æ‹©ä¸€ä¸ªçº¿ç¨‹å» notify()ï¼Œå…·ä½“é€‰æ‹©å“ªä¸€ä¸ªå’Œå…·ä½“çš„å®ç°æœ‰å…³ï¼Œå½“å‰çº¿ç¨‹åœ¨è°ƒç”¨ Object.notify() æ–¹æ³•ä»¥åä¼šå°±é‡Šæ”¾Objectçš„ç›‘è§†å™¨ï¼Œå’Œ wait() æ–¹æ³•ä¸€æ ·ï¼ŒObject.notify() æ–¹æ³•åªæœ‰åœ¨å½“å‰çº¿ç¨‹æŒæœ‰ Object çš„ç›‘è§†å™¨çš„æ—¶å€™æ‰èƒ½å¤Ÿè°ƒç”¨ï¼Œä¸ç„¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li>
  <li>Object.notifyAll() æ–¹æ³•ï¼šå”¤é†’æ‰€æœ‰è°ƒç”¨äº† Object.wait() æ–¹æ³•çš„çº¿ç¨‹ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹è°ƒç”¨äº† Object.wait() æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šå¼•å‘è¿™äº›çº¿ç¨‹ä¹‹é—´çš„ç«äº‰ï¼Œæœ€åè°æˆåŠŸè·å–åˆ° Object çš„ç›‘è§†å™¨å’Œå…·ä½“çš„å®ç°æœ‰å…³ï¼Œå½“å‰çº¿ç¨‹åœ¨è°ƒç”¨ Object.notifyAll() æ–¹æ³•ä»¥åä¼šå°±é‡Šæ”¾ Object çš„ç›‘è§†å™¨ï¼Œå’Œ wait() æ–¹æ³•ä¸€æ ·ï¼ŒObject.notifyAll() æ–¹æ³•åªæœ‰åœ¨å½“å‰çº¿ç¨‹åªæœ‰ Object çš„ç›‘è§†å™¨çš„æ—¶å€™æ‰èƒ½å¤Ÿè°ƒç”¨ï¼Œä¸ç„¶å°±ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</li>
</ul>

<p>é‚£ä¹ˆ Condition æ˜¯å¦‚ä½•å®ç° waitï¼Œnotify å’Œ notifyAll æ–¹æ³•çš„åŠŸèƒ½å‘¢ï¼Ÿæˆ‘ä»¬æ¥ä¸‹æ¥çœ‹ï¼š</p>

<p>åœ¨ Condition ä¸­ï¼Œwaitï¼Œnotify å’Œ notifyAll æ–¹æ³•åˆ†åˆ«å¯¹åº”äº† awaitï¼Œsignal å’Œ signalAll æ–¹æ³•ï¼Œå½“ç„¶ Condition ä¹Ÿæä¾›äº†è¶…æ—¶çš„ã€ä¸å¯è¢«ä¸­æ–­çš„ await() æ–¹æ³•ï¼Œä¸è¿‡æˆ‘ä»¬ä¸»è¦è¿˜æ˜¯çœ‹ä¸€çœ‹ awaitï¼Œnotify å’Œ notifyAll çš„å®ç°ï¼Œå…ˆçœ‹ awaitï¼š</p>

<h3 id="await-">await æ–¹æ³•</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">await</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">interrupted</span><span class="o">())</span>
</span><span class="line">        <span class="k">throw</span> <span class="k">new</span> <span class="nf">InterruptedException</span><span class="o">();</span>
</span><span class="line">    <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="n">addConditionWaiter</span><span class="o">();</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">savedState</span> <span class="o">=</span> <span class="n">fullyRelease</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">interruptMode</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class="line">    <span class="k">while</span> <span class="o">(!</span><span class="n">isOnSyncQueue</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">park</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
</span><span class="line">        <span class="k">if</span> <span class="o">((</span><span class="n">interruptMode</span> <span class="o">=</span> <span class="n">checkInterruptWhileWaiting</span><span class="o">(</span><span class="n">node</span><span class="o">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
</span><span class="line">            <span class="k">break</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">acquireQueued</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">savedState</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">interruptMode</span> <span class="o">!=</span> <span class="n">THROW_IE</span><span class="o">)</span>
</span><span class="line">        <span class="n">interruptMode</span> <span class="o">=</span> <span class="n">REINTERRUPT</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">nextWaiter</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">        <span class="n">unlinkCancelledWaiters</span><span class="o">();</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">interruptMode</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
</span><span class="line">        <span class="n">reportInterruptAfterWait</span><span class="o">(</span><span class="n">interruptMode</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>æ•´ä¸ª await çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<ul>
  <li>åœ¨ç¬¬ 2 è¡Œå¤„ï¼Œå¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‚</li>
  <li>åœ¨ç¬¬ 4 è¡Œå¤„ï¼Œå°†èŠ‚ç‚¹åŠ å…¥åˆ° Condition é˜Ÿåˆ—ä¸­å»ï¼Œè¿™é‡Œå¦‚æœ lastWaiter æ˜¯ cancel çŠ¶æ€ï¼Œé‚£ä¹ˆä¼šæŠŠå®ƒè¸¢å‡º Condition é˜Ÿåˆ—ã€‚</li>
  <li>åœ¨ç¬¬ 5 è¡Œå¤„ï¼Œè°ƒç”¨ tryReleaseï¼Œé‡Šæ”¾å½“å‰çº¿ç¨‹çš„é”</li>
  <li>åœ¨ç¬¬ 7 è¡Œå¤„ï¼Œåˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼ˆsignal æ“ä½œä¼šå°† Node ä» Condition é˜Ÿåˆ—ä¸­æ‹¿å‡ºå¹¶ä¸”æ”¾å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»ï¼‰ï¼Œå¦‚æœä¸åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­äº†ï¼Œå°± park å½“å‰çº¿ç¨‹ï¼Œå¦‚æœåœ¨ï¼Œå°±é€€å‡ºå¾ªç¯ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¢«ä¸­æ–­ï¼Œé‚£ä¹ˆå°±é€€å‡ºå¾ªç¯</li>
  <li>åœ¨ç¬¬ 12 è¡Œå¤„ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹å·²ç»è¢« signal() æˆ–è€… signalAll() æ“ä½œç»™å”¤é†’äº†ï¼Œé€€å‡ºäº† 4 ä¸­çš„ while å¾ªç¯ï¼Œå°è¯•å†æ¬¡è·å–é”ï¼Œè°ƒç”¨ acquireQueued æ–¹æ³•ã€‚</li>
</ul>

<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª await çš„æ“ä½œè¿‡ç¨‹å’Œ Object.wait() æ–¹æ³•æ˜¯ä¸€æ ·ï¼Œåªä¸è¿‡ await() é‡‡ç”¨äº† Condition é˜Ÿåˆ—çš„æ–¹å¼å®ç°äº† Object.wait() çš„åŠŸèƒ½ã€‚</p>

<h3 id="signal--signalall-">signal å’Œ signalAll æ–¹æ³•</h3>

<p>åœ¨äº†è§£äº† await æ–¹æ³•çš„å®ç°ä»¥åï¼Œsignal å’Œ signalAll æ–¹æ³•çš„å®ç°å°±ç›¸å¯¹ç®€å•äº†ï¼Œå…ˆçœ‹çœ‹ signal æ–¹æ³•ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">signal</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(!</span><span class="n">isHeldExclusively</span><span class="o">())</span>
</span><span class="line">        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalMonitorStateException</span><span class="o">();</span>
</span><span class="line">    <span class="n">Node</span> <span class="n">first</span> <span class="o">=</span> <span class="n">firstWaiter</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">first</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">        <span class="n">doSignal</span><span class="o">(</span><span class="n">first</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™é‡Œå…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æŒæœ‰é”ï¼Œå¦‚æœæ²¡æœ‰æŒæœ‰ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç„¶ååˆ¤æ–­æ•´ä¸ª condition é˜Ÿåˆ—æ˜¯å¦ä¸ºç©ºï¼Œä¸ä¸ºç©ºåˆ™è°ƒç”¨ doSignal æ–¹æ³•æ¥å”¤é†’çº¿ç¨‹ï¼Œçœ‹çœ‹ doSignal æ–¹æ³•éƒ½å¹²äº†ä¸€äº›ä»€ä¹ˆï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doSignal</span><span class="o">(</span><span class="n">Node</span> <span class="n">first</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">do</span> <span class="o">{</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span> <span class="o">(</span><span class="n">firstWaiter</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">nextWaiter</span><span class="o">)</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">            <span class="n">lastWaiter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">        <span class="n">first</span><span class="o">.</span><span class="na">nextWaiter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span> <span class="k">while</span> <span class="o">(!</span><span class="n">transferForSignal</span><span class="o">(</span><span class="n">first</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span><span class="line">             <span class="o">(</span><span class="n">first</span> <span class="o">=</span> <span class="n">firstWaiter</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™ä¸ª while å¾ªç¯çš„ä½œç”¨å°±æ˜¯å°† firstWaiter å¾€ Condition é˜Ÿåˆ—çš„åé¢ç§»ä¸€ä½ï¼Œå¹¶ä¸”å”¤é†’ firstï¼Œçœ‹çœ‹ while å¾ªç¯ä¸­ tranferForSignalï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">transferForSignal</span><span class="o">(</span><span class="n">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="cm">/*</span>
</span><span class="line"><span class="cm">     * If cannot change waitStatus, the node has been cancelled.</span>
</span><span class="line"><span class="cm">     */</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(!</span><span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">Node</span><span class="o">.</span><span class="na">CONDITION</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
</span><span class="line">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/*</span>
</span><span class="line"><span class="cm">     * Splice onto queue and try to set waitStatus of predecessor to</span>
</span><span class="line"><span class="cm">     * indicate that thread is (probably) waiting. If cancelled or</span>
</span><span class="line"><span class="cm">     * attempt to set waitStatus fails, wake up to resync (in which</span>
</span><span class="line"><span class="cm">     * case the waitStatus can be transiently and harmlessly wrong).</span>
</span><span class="line"><span class="cm">     */</span>
</span><span class="line">    <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">enq</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">waitStatus</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">))</span>
</span><span class="line">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">thread</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç çš„ä½œç”¨å°±æ˜¯ä¿®æ”¹ Node çš„ waitStatus ä¸º 0ï¼Œç„¶åå°† Node æ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”å”¤é†’ Nodeã€‚</p>

<p>signalAll å’Œ signal æ–¹æ³•ç±»ä¼¼ï¼Œä¸»è¦çš„ä¸åŒåœ¨äºå®ƒä¸æ˜¯è°ƒç”¨ doSignal æ–¹æ³•ï¼Œè€Œæ˜¯è°ƒç”¨ doSignalAll æ–¹æ³•ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">doSignalAll</span><span class="o">(</span><span class="n">Node</span> <span class="n">first</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">lastWaiter</span> <span class="o">=</span> <span class="n">firstWaiter</span>  <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">    <span class="k">do</span> <span class="o">{</span>
</span><span class="line">        <span class="n">Node</span> <span class="n">next</span> <span class="o">=</span> <span class="n">first</span><span class="o">.</span><span class="na">nextWaiter</span><span class="o">;</span>
</span><span class="line">        <span class="n">first</span><span class="o">.</span><span class="na">nextWaiter</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">        <span class="n">transferForSignal</span><span class="o">(</span><span class="n">first</span><span class="o">);</span>
</span><span class="line">        <span class="n">first</span> <span class="o">=</span> <span class="n">next</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">first</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™ä¸ªæ–¹æ³•å°±ç›¸å½“äºæŠŠ Condition é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ Node å…¨éƒ¨å–å‡ºæ’å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»ã€‚</p>

<h3 id="section">æ€»ç»“</h3>

<p>åœ¨äº†è§£äº† awaitï¼Œsignal å’Œ signalAll æ–¹æ³•çš„å®ç°ä»¥åï¼Œæˆ‘ä»¬å†æ¥é€šè¿‡ä¸€å‰¯ gif åŠ¨ç”»æ¥çœ‹ä¸€çœ‹è¿™ä¸€ä¸ªæ•´ä½“çš„è¿‡ç¨‹ï¼š</p>

<p><img src="http://farm3.staticflickr.com/2888/9263654699_6b959eecb2_o.gif" alt="image" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/blog/2013/07/10/juc-lock-acquire-release/">Java å¹¶å‘ç¼–ç¨‹ J.U.C ä¹‹é”çš„è·å–ä¸é‡Šæ”¾</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-10T20:14:00+08:00" pubdate data-updated="true">Jul 10<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/07/10/juc-lock-acquire-release/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>æ­¤ç¯‡æ–‡ç« æ˜¯ä½œè€…ä¸¤å¹´å‰å‘è¡¨åœ¨<a href="http://www.goldendoc.org/2011/06/lock_acquire_release/">é»„é‡‘æ¡£</a>çš„æ–‡ç« ã€‚</strong></p>

<p>ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å¯¹ <a href="http://www.goldendoc.org/2011/05/juc/">J.U.C çš„ä¸€äº›å¤§æ¦‚çš„æƒ…å†µ</a>åšäº†äº†è§£ï¼Œåœ¨è¿™ä¸€ç¯‡æ–‡ç« æˆ‘ä»¬å°†æ¥ä»¥ ReentrantLock ä¸ºä¾‹ï¼Œæ¥åˆ†æä¸€ä¸‹é”çš„è·å–å’Œé‡Šæ”¾çš„è¿‡ç¨‹ï¼Œè®©å¤§å®¶èƒ½å¤Ÿå¯¹é”çš„è·å–å’Œé‡Šæ”¾çš„æ•´ä½“è¿‡ç¨‹æœ‰ä¸€ä¸ªäº†è§£ã€‚</p>

<h3 id="section">ä¸€ã€é”çš„è·å–</h3>

<p>å…ˆçœ‹ä¸‹ ReentrantLock çš„ lock() æ–¹æ³•ï¼Œæ•´ä¸ªæ–¹æ³•åªæœ‰ä¸€è¡Œï¼Œè°ƒç”¨ acquire æ–¹æ³•ï¼Œçœ‹çœ‹ acquire æ–¹æ³•çš„å®ç°ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">acquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(!</span><span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span><span class="line">        <span class="n">acquireQueued</span><span class="o">(</span><span class="n">addWaiter</span><span class="o">(</span><span class="n">Node</span><span class="o">.</span><span class="na">EXCLUSIVE</span><span class="o">),</span> <span class="n">arg</span><span class="o">))</span>
</span><span class="line">        <span class="n">selfInterrupt</span><span class="o">();</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç çš„å®ç°ä¹Ÿæ˜¯æ¯”è¾ƒç®€æ´ï¼Œå…ˆå°è¯•ä¸€æ¬¡ tryAcquire æ“ä½œï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™æŠŠå½“å‰çº¿ç¨‹åŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­å»ï¼Œè¿™ä¸ªæ—¶å€™å¯èƒ½ä¼šåå¤çš„é˜»å¡ä¸å”¤é†’è¿™ä¸ªçº¿ç¨‹ï¼Œç›´åˆ°åç»­çš„ tryAcquireï¼ˆçœ‹ acquireQueued çš„å®ç°ï¼‰æ“ä½œæˆåŠŸã€‚</p>

<p>å†çœ‹çœ‹ tryAcquire çš„å®ç°ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryAcquire</span><span class="o">(</span><span class="kt">int</span> <span class="n">acquires</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">final</span> <span class="n">Thread</span> <span class="n">current</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">();</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span><span class="n">isFirst</span><span class="o">(</span><span class="n">current</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span><span class="line">            <span class="n">compareAndSetState</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">acquires</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">            <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="n">current</span><span class="o">);</span>
</span><span class="line">            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">current</span> <span class="o">==</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">        <span class="kt">int</span> <span class="n">nextc</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="n">acquires</span><span class="o">;</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span><span class="n">nextc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
</span><span class="line">            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Error</span><span class="o">(</span><span class="s">&quot;Maximum lock count exceeded&quot;</span><span class="o">);</span>
</span><span class="line">        <span class="n">setState</span><span class="o">(</span><span class="n">nextc</span><span class="o">);</span>
</span><span class="line">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç æ˜¯å°è¯•è·å–é”çš„è¿‡ç¨‹ï¼Œå®ƒå…ˆåˆ¤æ–­å½“å‰çš„ AQS çš„ state å€¼ï¼Œå¦‚æœä¸º 0ï¼Œåˆ™è¡¨ç¤ºè¯¥é”æ²¡æœ‰è¢«æŒæœ‰è¿‡ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™åŒæ­¥é˜Ÿåˆ—æ˜¯ç©ºçš„æˆ–è€…å½“å‰çº¿ç¨‹å°±æ˜¯åœ¨åŒæ­¥é˜Ÿåˆ—çš„å¤´éƒ¨ï¼Œé‚£ä¹ˆä¿®æ”¹ state çš„å€¼ï¼Œå¹¶ä¸”è®¾ç½®æ’ä»–é”çš„æŒæœ‰çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹</p>

<p>å¦‚æœå¤§äº 0ï¼Œåˆ™åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯æ’ä»–é”çš„æŒæœ‰çº¿ç¨‹ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆæŠŠ state å€¼åŠ  1ï¼ˆæ³¨æ„ state æ˜¯ int ç±»å‹çš„ï¼Œæ‰€ä»¥ state çš„æœ€å¤§å€¼æ˜¯å°±æ˜¯ int çš„æœ€å¤§å€¼ï¼‰</p>

<p>å¦‚æœç¬¬ä¸€æ¬¡ tryAcquire() æ“ä½œå¤±è´¥ï¼Œé‚£ä¹ˆå°±æŠŠå½“å‰çº¿ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»ï¼Œçœ‹ addWaiter() æ–¹æ³•ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">private</span> <span class="n">Node</span> <span class="nf">addWaiter</span><span class="o">(</span><span class="n">Node</span> <span class="n">mode</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">Node</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Node</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">(),</span> <span class="n">mode</span><span class="o">);</span>
</span><span class="line">    <span class="c1">// Try the fast path of enq; backup to full enq on failure</span>
</span><span class="line">    <span class="n">Node</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">pred</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">node</span><span class="o">.</span><span class="na">prev</span> <span class="o">=</span> <span class="n">pred</span><span class="o">;</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span><span class="n">compareAndSetTail</span><span class="o">(</span><span class="n">pred</span><span class="o">,</span> <span class="n">node</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">            <span class="n">pred</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">;</span>
</span><span class="line">            <span class="k">return</span> <span class="n">node</span><span class="o">;</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">enq</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">node</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç ä¸­å…ˆå°è¯•äº†ä¸€ä¸‹äº†ä¸‹ enq() æ–¹æ³•ä¸­ç­‰å¾…é˜Ÿåˆ—ä¸ä¸ºç©ºçš„æƒ…å†µï¼Œå¦‚æœå¤±è´¥ï¼Œå†è°ƒç”¨ enq() æ–¹æ³•å°†å½“å‰çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œenq() çš„è¿‡ç¨‹æˆ‘ä»¬å·²ç»åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è®²è¿‡äº†ï¼Œä¸å†èµ˜è¿°ã€‚</p>

<p>æœ€ååœ¨å½“å‰çº¿ç¨‹è¢«åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»ä»¥åï¼Œå†è°ƒç”¨ acquireQueued å»è·å–é”ï¼Œçœ‹çœ‹ acquireQueued çš„ä»£ç ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">acquireQueued</span><span class="o">(</span><span class="kd">final</span> <span class="n">Node</span> <span class="n">node</span><span class="o">,</span> <span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">try</span> <span class="o">{</span>
</span><span class="line">        <span class="kt">boolean</span> <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line">        <span class="k">for</span> <span class="o">(;;)</span> <span class="o">{</span>
</span><span class="line">            <span class="kd">final</span> <span class="n">Node</span> <span class="n">p</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">predecessor</span><span class="o">();</span>
</span><span class="line">            <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">head</span> <span class="o">&amp;&amp;</span> <span class="n">tryAcquire</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">                <span class="n">setHead</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span><span class="line">                <span class="n">p</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// help GC</span>
</span><span class="line">                <span class="k">return</span> <span class="n">interrupted</span><span class="o">;</span>
</span><span class="line">            <span class="o">}</span>
</span><span class="line">            <span class="k">if</span> <span class="o">(</span><span class="n">shouldParkAfterFailedAcquire</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
</span><span class="line">                <span class="n">parkAndCheckInterrupt</span><span class="o">())</span>
</span><span class="line">                <span class="n">interrupted</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">cancelAcquire</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
</span><span class="line">        <span class="k">throw</span> <span class="n">ex</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç ä¸­æ‹¿åˆ°å½“å‰çº¿ç¨‹åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­çš„å‰é¢ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹æ˜¯æ˜¯å¤´éƒ¨ï¼Œé‚£ä¹ˆé©¬ä¸Šè¿›è¡Œä¸€æ¬¡ tryAcquire æ“ä½œï¼Œå¦‚æœæ“ä½œæˆåŠŸï¼Œé‚£ä¹ˆæŠŠå½“å‰çº¿ç¨‹å¼¹å‡ºé˜Ÿåˆ—ï¼Œæ•´ä¸ªæ“ä½œå°±æ­¤ç»“æŸã€‚å¦‚æœè¿™ä¸ªèŠ‚ç‚¹ä¸æ˜¯å¤´éƒ¨æˆ–è€…è¯´ tryAcquire æ“ä½œå¤±è´¥çš„è¯ï¼Œé‚£ä¹ˆå°±åˆ¤æ–­æ˜¯ä¸æ˜¯è¦å°†å½“å‰çº¿ç¨‹ç»™é˜»å¡æ‰ï¼ˆshouldParkAfterFailedAcquireï¼‰æ–¹æ³•ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡æ‰ï¼Œå®é™…ä¸Šåˆ¤æ–­çš„æ˜¯å½“å‰çº¿ç¨‹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€å°äº 0ï¼ˆcondition æˆ–è€… signalï¼‰ï¼Œé‚£ä¹ˆè¿”å› trueï¼Œé˜»å¡å½“å‰çº¿ç¨‹ï¼›å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€å¤§äº 0ï¼ˆcancelledï¼‰ï¼Œåˆ™å‘å‰éå†ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸å¤§äº 0 çš„èŠ‚ç‚¹ï¼Œå¹¶ä¸”å°†ä¸­é—´çš„ cancelled çŠ¶æ€çš„èŠ‚ç‚¹å…¨éƒ¨è¸¢å‡ºé˜Ÿåˆ—ï¼›å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ç­‰äº 0ï¼Œé‚£ä¹ˆå°†å…¶çŠ¶æ€ç½®ä¸º -1ï¼ˆsignalï¼‰ï¼Œå¹¶ä¸”è¿”å› falseï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡å¾ªç¯çš„æ—¶å€™å†é˜»å¡ã€‚</p>

<p><strong>æ•´ä¸ªé”çš„è·å–è¿‡ç¨‹å°±æ˜¯è¿™æ ·ï¼Œæˆ‘ä»¬å†æ¥æ€»ç»“ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹</strong>ï¼šacquire() æ–¹æ³•ä¼šå…ˆè°ƒç”¨ä¸€æ¬¡ tryAcquire æ–¹æ³•è·å–ä¸€æ¬¡é”ï¼Œå¦‚æœå¤±è´¥ï¼Œåˆ™æŠŠå½“å‰çº¿ç¨‹åŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å»ï¼Œç„¶åå†è°ƒç”¨ acquireQueued è·å–é”ï¼ŒacquireQueued åœ¨å½“å‰èŠ‚ç‚¹ä¸åœ¨å¤´éƒ¨çš„æ—¶å€™ä¼šæŠŠå½“å‰çº¿ç¨‹çš„å‰ä¸€ä¸ªç»“ç‚¹çš„çŠ¶æ€ç½®ä¸º SIGNALï¼Œç„¶åé˜»å¡å½“å‰çº¿ç¨‹ã€‚å½“å½“å‰çº¿ç¨‹åˆ°äº†é˜Ÿåˆ—çš„å¤´éƒ¨çš„æ—¶å€™ï¼Œé‚£ä¹ˆè·å–é”çš„æ“ä½œå°±ä¼šæˆåŠŸè¿”å›ã€‚</p>

<h3 id="section-1">äºŒã€é”çš„é‡Šæ”¾</h3>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬çŸ¥é“åœ¨ acquireQueued æ–¹æ³•ä¸­ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹æˆåŠŸè·å–åˆ°äº†é”ï¼Œé‚£ä¹ˆå®ƒå°±åº”è¯¥æ˜¯æ•´ä¸ªç­‰å¾…é˜Ÿåˆ—çš„ head èŠ‚ç‚¹ï¼Œç„¶åï¼Œæˆ‘ä»¬å†æ¥çœ‹ä¸€çœ‹ unlock() æ–¹æ³•ï¼Œå’Œ lock() æ–¹æ³•ä¸€æ ·ï¼Œunlock() æ–¹æ³•ä¹Ÿæ˜¯åªæœ‰ä¸€è¡Œä»£ç ï¼Œç›´æ¥è°ƒç”¨ release() æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹ release() æ–¹æ³•çš„å®ç°ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">release</span><span class="o">(</span><span class="kt">int</span> <span class="n">arg</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">tryRelease</span><span class="o">(</span><span class="n">arg</span><span class="o">))</span> <span class="o">{</span>
</span><span class="line">        <span class="n">Node</span> <span class="n">h</span> <span class="o">=</span> <span class="n">head</span><span class="o">;</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span><span class="n">h</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">h</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
</span><span class="line">            <span class="n">unparkSuccessor</span><span class="o">(</span><span class="n">h</span><span class="o">);</span>
</span><span class="line">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™ä¸ªè¿‡ç¨‹é¦–å…ˆè°ƒç”¨ tryRelease æ–¹æ³•ï¼Œå¦‚æœé”å·²ç»å®Œå…¨é‡Šæ”¾ï¼Œé‚£ä¹ˆå°±å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå…ˆæ¥çœ‹çœ‹ tryRelease æ–¹æ³•ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">protected</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">tryRelease</span><span class="o">(</span><span class="kt">int</span> <span class="n">releases</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">getState</span><span class="o">()</span> <span class="o">-</span> <span class="n">releases</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span> <span class="o">!=</span> <span class="n">getExclusiveOwnerThread</span><span class="o">())</span>
</span><span class="line">        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalMonitorStateException</span><span class="o">();</span>
</span><span class="line">    <span class="kt">boolean</span> <span class="n">free</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">free</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line">        <span class="n">setExclusiveOwnerThread</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="n">setState</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span><span class="line">    <span class="k">return</span> <span class="n">free</span><span class="o">;</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç é¦–å…ˆè·å–å½“å‰ AQS çš„ state çŠ¶æ€å¹¶ä¸”å°†å…¶å€¼å‡ä¸€ï¼Œå¦‚æœç»“æœç­‰äº 0ï¼ˆé”å·²ç»è¢«å®Œå…¨é‡Šæ”¾ï¼‰ï¼Œé‚£ä¹ˆå°†æ’ä»–é”çš„æŒæœ‰çº¿ç¨‹ç½®ä¸º nullã€‚å°† AQS çš„ state çŠ¶æ€ç½®ä¸ºå‡ä¸€åçš„ç»“æœã€‚</p>

<p>ç„¶åå†çœ‹çœ‹å”¤é†’ç»§ä»»èŠ‚ç‚¹çš„ä»£ç ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">unparkSuccessor</span><span class="o">(</span><span class="n">Node</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">    <span class="n">compareAndSetWaitStatus</span><span class="o">(</span><span class="n">node</span><span class="o">,</span> <span class="n">Node</span><span class="o">.</span><span class="na">SIGNAL</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
</span><span class="line">    <span class="n">Node</span> <span class="n">s</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">s</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">        <span class="n">s</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">        <span class="k">for</span> <span class="o">(</span><span class="n">Node</span> <span class="n">t</span> <span class="o">=</span> <span class="n">tail</span><span class="o">;</span> <span class="n">t</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">!=</span> <span class="n">node</span><span class="o">;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="na">prev</span><span class="o">)</span>
</span><span class="line">            <span class="k">if</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="na">waitStatus</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span>
</span><span class="line">                <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">s</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class="line">        <span class="n">LockSupport</span><span class="o">.</span><span class="na">unpark</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">thread</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™æ®µä»£ç å…ˆæ¸…é™¤å½“å‰èŠ‚ç‚¹çš„ waitStatus ä¸º 0ï¼Œç„¶ååˆ¤æ–­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ä¸æ˜¯ null æˆ–è€… cancelled çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™ä»é˜Ÿåˆ—çš„å°¾éƒ¨å¾€å‰å¼€å§‹æ‰¾ï¼Œæ‰¾åˆ°ä¸€ä¸ªé cancelled çŠ¶æ€çš„èŠ‚ç‚¹ï¼Œæœ€åå”¤é†’è¿™ä¸ªèŠ‚ç‚¹ã€‚</p>

<p><strong>æœ€åï¼Œæ€»ç»“ä¸€ä¸‹é‡Šæ”¾æ“ä½œçš„æ•´ä¸ªè¿‡ç¨‹</strong>ï¼šå…¶å®æ•´ä¸ªé‡Šæ”¾è¿‡ç¨‹å°±åšäº†ä¸¤ä»¶äº‹æƒ…ï¼Œä¸€ä¸ªæ˜¯å°†stateå€¼å‡1ï¼Œç„¶åå°±æ˜¯åˆ¤æ–­é”æ˜¯å¦è¢«å®Œå…¨é‡Šæ”¾ï¼Œå¦‚æœè¢«å®Œå…¨é‡Šæ”¾ï¼Œåˆ™å”¤é†’ç»§ä»»èŠ‚ç‚¹ã€‚</p>

<h3 id="section-2">ä¸‰ã€æ•´ä½“è¿‡ç¨‹æè¿°</h3>

<p>çœ‹äº†ä¸Šé¢çš„é”çš„è·å–ä¸é‡Šæ”¾æ“ä½œä»¥åï¼Œæ•´ä½“è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ï¼Œåœ¨æ–‡ç« çš„æœ€åï¼Œæˆ‘ä»¬æŠŠè·å–ä¸é‡Šæ”¾æ“ä½œä¸²åœ¨ä¸€èµ·åœ¨ç®€å•çœ‹ä¸€ä¸‹ï¼š</p>

<ul>
  <li>è·å–é”çš„æ—¶å€™å°†å½“å‰çº¿ç¨‹æ”¾å…¥åŒæ­¥é˜Ÿåˆ—ï¼Œå¹¶ä¸”å°†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€ç½®ä¸º signal çŠ¶æ€ï¼Œç„¶åé˜»å¡</li>
  <li>å½“è¿™ä¸ªèŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹æˆåŠŸè·å–åˆ°é”ï¼Œå‰ä¸€ä¸ªèŠ‚ç‚¹å°±æˆäº†æ•´ä¸ªåŒæ­¥é˜Ÿåˆ—çš„ headã€‚</li>
  <li>å½“å‰ä¸€ä¸ªèŠ‚ç‚¹é‡Šæ”¾é”çš„æ—¶å€™ï¼Œå®ƒå°±å”¤é†’å½“å‰çº¿ç¨‹çš„è¿™ä¸ªèŠ‚ç‚¹ï¼Œç„¶åå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹å°±å¯ä»¥æˆåŠŸè·å–åˆ°é”äº†</li>
  <li>è¿™ä¸ªæ—¶å€™å®ƒå°±åˆ°æ•´ä¸ªé˜Ÿåˆ—çš„å¤´éƒ¨äº†ï¼Œç„¶å release æ“ä½œçš„æ—¶å€™åˆå¯ä»¥å”¤é†’ä¸‹ä¸€ä¸ªã€‚</li>
</ul>
</div>
  
  


    </article>
  
  <ul class="pager">
    
    <li class="previous"><a href="/blog/page/5/">&larr; Older</a></li>
    
    <li><a href="/blog/archives">Blog Archives</a></li>
    
    <li class="next"><a href="/blog/page/3/">Newer &rarr;</a></li>
    
  </ul>
</div>
<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/blog/2020/08/09/tlou2/">ã€Œæœ€åçš„ç”Ÿè¿˜è€…ï¼šç¬¬äºŒç¯‡ç« ã€æ¸¸æˆä½“éªŒ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/10/08/jdk13-dynamic-cds/">JDK13 æ–°ç‰¹æ€§ä¹‹ Dynamic CDS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/10/06/new-zealand/">æ–°è¥¿å…°æ¸¸è®°</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/10/06/the-legend-of-heroes-4/">é—ªä¹‹è½¨è¿¹ 4 ç©åæ„Ÿ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/03/24/springboot-on-kubernetes/">SpringBoot on Kubernetes</a>
      </li>
    
  </ul>
</section>

<section class="well">
  <ul id="gh_repos" class="nav">
    <li class="nav-header">GitHub Repos</li>
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/khotyn">@khotyn</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        github.showRepos({
            user: 'khotyn',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/asides/github.js" type="text/javascript"> </script>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2020 - khotyn -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'khotynblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
