
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>å…³é—­ Tomcat çš„ TLD æ‰«æçš„åŠŸèƒ½ - å°å¾„åˆ†å²”çš„èŠ±å›­</title>
  <meta name="author" content="khotyn">

  
  <meta name="description" content="">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://khotyn.github.com/blog/2014/01/21/turnoff-tomcat-tld-scan">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="å°å¾„åˆ†å²”çš„èŠ±å›­" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44033767-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar navbar-inverse">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">å°å¾„åˆ†å²”çš„èŠ±å›­</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/blog/archives">ğŸ—‚å½’æ¡£</a></li>
  <li><a href="/about">ğŸ‘¨å…³äº</a></li>
  <li><a href="/hire">ğŸ‘¨â€ğŸ’»æ‹›è˜</a></li>
  <li><a href="https://github.com/khotyn" target="_blank">æˆ‘çš„ Github</a></li>
</ul>

        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="https://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:blog.khotyn.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      
<article class="hentry span9" role="article">

  
  <header class="page-header">
    
      <h1 class="entry-title">å…³é—­ Tomcat çš„ TLD æ‰«æçš„åŠŸèƒ½</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-21T19:12:00-06:00" pubdate data-updated="true">Jan 21<span>st</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><h3 id="section">èƒŒæ™¯</h3>

<p>Tomcat ä½œä¸º Servlet è§„èŒƒçš„å®ç°è€…ï¼Œå®ƒåœ¨åº”ç”¨å¯åŠ¨çš„æ—¶å€™ä¼šæ‰«æ Jar åŒ…é‡Œé¢çš„ .tld æ–‡ä»¶ï¼ŒåŠ è½½é‡Œé¢å®šä¹‰çš„æ ‡ç­¾åº“ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬åœ¨å¼€å‘çš„æ—¶å€™å¾ˆå¤šéƒ½ä¸æ˜¯é‡‡ç”¨ JSP ä½œä¸º Web é¡µé¢çš„æ¨¡æ¿çš„ï¼Œå¾ˆå¤šéƒ½æ˜¯ä½¿ç”¨  Velocity ä¹‹ç±»çš„æ¨¡æ¿å¼•æ“ï¼Œè‡ªç„¶è€Œç„¶ï¼Œä¸ºäº†åŠ å¿«åº”ç”¨çš„å¯åŠ¨é€Ÿåº¦ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ Tomcat é‡Œé¢çš„è¿™ä¸ªåŠŸèƒ½ç»™å…³æ‰ã€‚</p>

<h3 id="section-1">æ–¹æ³•</h3>

<p>çœ‹ Tomcat çš„é…ç½®æ–‡æ¡£ï¼Œå…³äº Context çš„è®¾ç½®è¿™ä¸€å—ï¼Œçœ‹åˆ°äº† <code>processTlds</code> è¿™ä¸ªå±æ€§å¯ä»¥è®¾ç½®ï¼Œçœ‹ä¸‹è¿™ä¸ªå±æ€§çš„è¯´æ˜ï¼š</p>

<blockquote>
  <p>Whether the context should process TLDs on startup. The default is true. The false setting is intended for special cases that know in advance TLDs are not part of the webapp.</p>
</blockquote>

<p>åªè¦åœ¨ Context ä¸­æŠŠè¿™ä¸ªå±æ€§è®¾ç½®æˆ falseï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å…³é—­ Tomcat çš„ TLD æ‰«æåŠŸèƒ½äº†ï¼Œä¸ºäº†è®©æ‰€æœ‰çš„åº”ç”¨éƒ½å¯ä»¥å…³é—­è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å°† Tomcat ç›®å½•ä¸‹çš„ conf/context.xml ä¿®æ”¹æˆå¦‚ä¸‹è¿™æ ·ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line">&lt;?xml version='1.0' encoding='utf-8'?&gt;
</span><span class="line">&lt;Context processTlds="false"&gt;
</span><span class="line">    &lt;WatchedResource&gt;WEB-INF/web.xml&lt;/WatchedResource&gt;
</span><span class="line">&lt;/Context&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="section-2">å‘</h4>

<p>ä½†æ˜¯ï¼Œåœ¨ Tomcat 6 ä¸­æµ‹è¯•çš„æ—¶å€™ï¼Œå‘ç°è¿™ä¸ªåŠŸèƒ½æ²¡æœ‰ç”Ÿæ•ˆï¼Œæ— å¥ˆåªèƒ½ Debug Tomcat çš„æºç ï¼Œå‘ç° StandardContext çš„ init æ–¹æ³•ä¸‹æœ‰å¦‚ä¸‹ä»£ç ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class=""><span class="line">if (processTlds) {
</span><span class="line">    this.addLifecycleListener(new TldConfig());
</span><span class="line">}
</span><span class="line">
</span><span class="line">super.init();
</span><span class="line">
</span><span class="line">// Notify our interested LifecycleListeners
</span><span class="line">lifecycle.fireLifecycleEvent(INIT_EVENT, null);</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>è¿™é‡Œéœ€è¦è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼Œæˆ‘ä»¬çš„é»˜è®¤çš„ context é…ç½®æ˜¯åœ¨ <code>lifecycle.fireLifecycleEvent(INIT_EVENT, null);</code> è¿™è¡Œä»£ç ä¸­è¢«å¤„ç†çš„ï¼Œè€Œåœ¨è¿™è¡Œä»£ç ä¹‹å‰ï¼ŒTomcat å°±å·²ç»ä½¿ç”¨äº† <code>processTlds</code>ï¼Œæˆ‘ä»¬çš„é…ç½®å®Œå…¨æ²¡æœ‰ç”Ÿæ•ˆã€‚</p>

<h4 id="workaround">Workaround</h4>

<p>é‚£ä¹ˆï¼Œè¿™ä¹ˆè§£å†³å‘¢ï¼Ÿåœ¨ context ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é…ç½®ä¸€ä¸ª JarScannerï¼Œè¿™ä¸ª JarScanner ä¼šè¢«ç”¨æ¥æ‰«æ Jar åŒ…ä¸­çš„ tld æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨é»˜è®¤çš„ context.xml ä¸­é…ç½®ä¸€ä¸ªç©ºçš„ JarScannerï¼Œåƒä¸‹é¢è¿™æ ·ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class=""><span class="line">&lt;?xml version='1.0' encoding='utf-8'?&gt;
</span><span class="line">&lt;Context processTlds="false"&gt;
</span><span class="line">    &lt;JarScanner className="com.alipay.sofa.runtime.test.patch.tomcat.NullJarScanner"/&gt;
</span><span class="line">&lt;/Context&gt;</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>NullJarScanner çš„ä»£ç å¦‚ä¸‹ï¼š</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class=""><span class="line">package com.alipay.sofa.runtime.test.patch.tomcat;
</span><span class="line">
</span><span class="line">import org.apache.tomcat.JarScanner;
</span><span class="line">import org.apache.tomcat.JarScannerCallback;
</span><span class="line">
</span><span class="line">import javax.servlet.ServletContext;
</span><span class="line">import java.util.Set;
</span><span class="line">
</span><span class="line">/**
</span><span class="line"> * @author khotyn 14-1-21 ä¸‹åˆ4:37
</span><span class="line"> */
</span><span class="line">public class NullJarScanner implements JarScanner {
</span><span class="line">    @Override
</span><span class="line">    public void scan(ServletContext context, ClassLoader classloader, JarScannerCallback callback, Set&lt;String&gt; jarsToSkip) {
</span><span class="line">        // Do nothing at all.
</span><span class="line">    }
</span><span class="line">}
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒTomcat 7 ä¸ä¼šå‡ºç°ä¸Šè¿°çš„é—®é¢˜ï¼Œä½ åªè¦åœ¨é…ç½®ä¸­æŠŠ processTlds è®¾ç½®æˆ false å³å¯ã€‚</strong></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">khotyn</span></span>

      








  


<time datetime="2014-01-21T19:12:00-06:00" pubdate data-updated="true">Jan 21<span>st</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/java/'>Java</a>, <a class='category' href='/blog/categories/programming/'>Programming</a>, <a class='category' href='/blog/categories/tomcat/'>Tomcat</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    
    <section>
      <h1>Comments</h1>
      <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
    
    <ul class="pager">
      
      <li class="previous"><a class="basic-alignment left"
        href="/blog/2014/01/19/java-8-default-method/" title="Previous Post:
        Java 8 ä¹‹ default method">&laquo; Java 8 ä¹‹ default method</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
      <li class="next"><a class="basic-alignment right" href="/blog/2014/03/31/unittest/"
        title="Next Post: ä¸€äº›å…³äºå•å…ƒæµ‹è¯•çš„æ€è€ƒ">ä¸€äº›å…³äºå•å…ƒæµ‹è¯•çš„æ€è€ƒ
        &raquo;</a></li>
      
    </ul>
  </footer>
</article>

<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/blog/2019/10/06/new-zealand/">æ–°è¥¿å…°æ¸¸è®°</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/10/06/the-legend-of-heroes-4/">é—ªä¹‹è½¨è¿¹ 4 ç©åæ„Ÿ</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/03/24/springboot-on-kubernetes/">SpringBoot on Kubernetes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/03/21/app-cds/">Java 10 æ–°ç‰¹æ€§ä¹‹ AppCDS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/02/19/cloud-native-infrastrcuture/">Cloud Native Infrastrcuture é˜…è¯»ç¬”è®°</a>
      </li>
    
  </ul>
</section>

<section class="well">
  <ul id="gh_repos" class="nav">
    <li class="nav-header">GitHub Repos</li>
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/khotyn">@khotyn</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        github.showRepos({
            user: 'khotyn',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/asides/github.js" type="text/javascript"> </script>
</section>






  
</aside>


    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2019 - khotyn -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'khotynblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://khotyn.github.com/blog/2014/01/21/turnoff-tomcat-tld-scan/';
        var disqus_url = 'http://khotyn.github.com/blog/2014/01/21/turnoff-tomcat-tld-scan/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
